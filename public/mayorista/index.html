<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7c3aed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mayorista">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Verificador Mayorista</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; padding-bottom: 80px; }
    .header { background: #7c3aed; color: white; padding: 16px; text-align: center; }
    .header h1 { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .nav-tabs { display: flex; gap: 8px; justify-content: center; }
    .nav-tab { padding: 8px 24px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: white; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .nav-tab:hover { background: rgba(255,255,255,0.1); }
    .nav-tab.active { background: white; color: #7c3aed; border-color: white; }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .scan-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .scan-input-group { display: flex; gap: 8px; }
    .scan-input { flex: 1; padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; }
    .scan-btn { padding: 14px 20px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .scan-btn:disabled { background: #9ca3af; }
    .camera-btn { position: fixed; bottom: 0; left: 0; right: 0; padding: 18px; background: #059669; color: white; border: none; font-size: 18px; font-weight: 600; cursor: pointer; z-index: 90; }
    .camera-btn.product-mode { background: #7c3aed; }
    .camera-container { display: none; margin-top: 16px; position: relative; }
    .camera-container.active { display: block; }
    #video { width: 100%; border-radius: 8px; }
    .close-camera { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .status-message.show { display: block; }
    .status-message.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-message.loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .status-message.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .items-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .items-header { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .items-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .items-count { font-size: 14px; color: #6b7280; }
    .item-card { padding: 16px; padding-right: 60px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: flex-start; gap: 12px; transition: all 0.3s ease; position: relative; }
    .item-card:last-child { border-bottom: none; }
    .item-card.checked { background: #f0fdf4; }
    .item-card.highlight { background: #fef3c7; animation: pulse 0.5s ease-in-out; }
    .item-card.just-scanned { background: #dcfce7; border-left: 4px solid #22c55e; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .item-main-checkbox { width: 28px; height: 28px; cursor: pointer; flex-shrink: 0; margin-top: 4px; pointer-events: none; }
    .item-info { flex: 1; }
    .item-description { font-size: 20px; font-weight: 700; color: #111827; line-height: 1.3; }
    .item-sku { font-size: 14px; color: #6b7280; margin-top: 6px; font-family: monospace; }
    .item-quantity { font-size: 18px; color: #111827; font-weight: 700; margin-top: 8px; background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; }
    .unit-checkboxes { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
    .unit-checkbox { width: 36px; height: 36px; cursor: pointer; accent-color: #22c55e; }
    .unit-checkbox.scanned { outline: 3px solid #7c3aed; outline-offset: 2px; }
    .complete-banner { display: none; position: fixed; bottom: 56px; left: 0; right: 0; background: #22c55e; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: 600; z-index: 100; }
    .complete-banner.show { display: block; }
    .reset-btn { width: 100%; padding: 14px; margin-top: 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .hidden { display: none; }

    /* Banner grande de escaneo exitoso */
    .scan-success-banner { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(34, 197, 94, 0.95); color: white; z-index: 500; align-items: center; justify-content: center; flex-direction: column; animation: scanSuccessFade 0.5s ease-out forwards; }
    .scan-success-banner.show { display: flex; }
    .scan-success-banner .scan-icon { font-size: 80px; margin-bottom: 16px; animation: scanBounce 0.5s ease-out; }
    .scan-success-banner .scan-text { font-size: 28px; font-weight: 700; text-align: center; padding: 0 20px; }
    .scan-success-banner .scan-sku { font-size: 18px; font-weight: 400; margin-top: 8px; opacity: 0.9; }
    .scan-success-banner .scan-count { font-size: 48px; font-weight: 800; margin-top: 16px; }
    @keyframes scanSuccessFade { 0% { opacity: 1; } 50% { opacity: 1; } 100% { opacity: 0; pointer-events: none; } }
    @keyframes scanBounce { 0% { transform: scale(0.5); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

    /* Banner de error de escaneo */
    .scan-error-banner { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(220, 38, 38, 0.95); color: white; z-index: 500; align-items: center; justify-content: center; flex-direction: column; animation: scanSuccessFade 2s ease-out forwards; }
    .scan-error-banner.show { display: flex; }
    .scan-error-banner .scan-icon { font-size: 80px; margin-bottom: 16px; }
    .scan-error-banner .scan-text { font-size: 24px; font-weight: 700; text-align: center; padding: 0 20px; }

    /* Vision/IA - Análisis con Claude */
    .capture-photo-btn { position: fixed; bottom: 0; left: 0; right: 0; background: #f59e0b; color: white; border: none; padding: 18px; font-size: 18px; font-weight: 600; cursor: pointer; z-index: 100; }
    .capture-photo-btn:disabled { background: #9ca3af; }
    /* Freeze overlay */
    #capturedOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: none; object-fit: cover; }
    .camera-container.frozen #capturedOverlay { display: block; }
    .camera-container.frozen .capture-photo-btn { display: none; }
    /* Multi-foto UI */
    .multi-photo-bar { position: fixed; bottom: 0; left: 0; right: 0; display: none; z-index: 100; }
    .multi-photo-bar.active { display: flex; }
    .multi-photo-bar button { flex: 1; padding: 18px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; color: white; }
    .multi-photo-bar .btn-otra-foto { background: #3b82f6; }
    .multi-photo-bar .btn-enviar-analisis { background: #059669; }
    .multi-photo-bar .btn-enviar-analisis:disabled { background: #9ca3af; cursor: not-allowed; }
    .photo-thumbnails { display: flex; gap: 6px; padding: 8px; background: rgba(0,0,0,0.5); position: absolute; bottom: 8px; left: 8px; right: 8px; border-radius: 8px; overflow-x: auto; }
    .photo-thumbnails:empty { display: none; }
    .photo-thumb { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 2px solid white; flex-shrink: 0; }
    .vision-result { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 12px; }
    .vision-result-text { font-family: monospace; font-size: 14px; white-space: pre-wrap; word-break: break-all; }
    .vision-result-colors { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .verify-photo-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #7c3aed; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(124,58,237,0.4); transition: all 0.2s; }
    .verify-photo-btn:hover { background: #6d28d9; transform: translateY(-50%) scale(1.1); }
    .verify-photo-btn:active { background: #5b21b6; transform: translateY(-50%) scale(0.95); }
    .item-card { padding-right: 80px; }

    /* Toggle lector USB */
    .usb-toggle-container { position: fixed; bottom: 56px; right: 16px; z-index: 90; display: none; align-items: center; gap: 8px; }
    .usb-toggle-container.show { display: flex; }
    .usb-toggle-label { font-size: 12px; color: #6b7280; font-weight: 600; background: white; padding: 4px 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .usb-toggle { position: relative; width: 44px; height: 24px; background: #d1d5db; border-radius: 12px; cursor: pointer; transition: background 0.2s; border: none; padding: 0; }
    .usb-toggle.active { background: #22c55e; }
    .usb-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; }
    .usb-toggle.active::after { transform: translateX(20px); }
    .usb-scanner-input { position: fixed; bottom: 90px; left: 16px; right: 16px; z-index: 90; padding: 14px 16px; font-size: 18px; border: 3px solid #22c55e; border-radius: 10px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: monospace; text-align: center; }
    .usb-scanner-input:focus { outline: none; border-color: #16a34a; }
    .usb-scanner-input.hidden { display: none; }

    /* Modal para guardar barcode */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; }
    .modal h3 { font-size: 18px; margin-bottom: 16px; color: #111827; }
    .modal p { font-size: 14px; color: #6b7280; margin-bottom: 16px; }
    .modal-barcode { font-family: monospace; background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 16px; font-weight: 600; }
    .modal-sku-list { max-height: 200px; overflow-y: auto; margin-bottom: 16px; }
    .modal-sku-option { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
    .modal-sku-option:hover { border-color: #7c3aed; background: #f5f3ff; }
    .modal-sku-option.selected { border-color: #7c3aed; background: #f5f3ff; }
    .modal-sku-name { font-weight: 600; color: #111827; }
    .modal-sku-desc { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
    .modal-btn.primary { background: #7c3aed; color: white; }
    .modal-btn.secondary { background: #f3f4f6; color: #374151; }

    /* Modo edición */
    /* Edición de items en order-loaded */
    .edit-mode-btn { padding: 6px 14px; border: 2px solid #7c3aed; background: white; color: #7c3aed; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .edit-mode-btn.active { background: #7c3aed; color: white; }
    .preview-item.editing { padding: 12px 0; }
    .preview-item-actions { display: none; }
    .preview-item.editing .preview-item-actions { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .preview-delete-btn { width: 28px; height: 28px; border-radius: 50%; background: #fef2f2; color: #dc2626; border: 2px solid #fecaca; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .preview-delete-btn:hover { background: #dc2626; color: white; }
    .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e5e7eb; background: white; font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #374151; }
    .qty-btn:hover { border-color: #7c3aed; background: #f5f3ff; }
    .qty-btn:active { transform: scale(0.9); }
    .qty-display { font-size: 16px; font-weight: 700; color: #374151; min-width: 24px; text-align: center; }
    .add-item-btn { display: none; width: 100%; padding: 14px; border: 2px dashed #d1d5db; background: #f9fafb; color: #6b7280; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-radius: 8px; margin-top: 8px; }
    .add-item-btn:hover { border-color: #7c3aed; color: #7c3aed; background: #f5f3ff; }
    .add-item-btn.show { display: block; }

    /* Scan mode indicator */
    .scan-mode-indicator { display: none; background: #7c3aed; color: white; padding: 8px 16px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 14px; font-weight: 600; }
    .scan-mode-indicator.show { display: block; }

    /* Resumen del día */
    .resumen-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .resumen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .resumen-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .resumen-fecha { font-size: 12px; color: #6b7280; }
    .resumen-stats { display: flex; gap: 12px; margin-bottom: 16px; }
    .resumen-stat { flex: 1; text-align: center; padding: 12px; border-radius: 8px; }
    .resumen-stat.total { background: #f5f3ff; }
    .resumen-stat.verificados { background: #f0fdf4; }
    .resumen-stat.pendientes { background: #fef2f2; }
    .resumen-stat-number { font-size: 24px; font-weight: 700; }
    .resumen-stat.total .resumen-stat-number { color: #7c3aed; }
    .resumen-stat.verificados .resumen-stat-number { color: #16a34a; }
    .resumen-stat.pendientes .resumen-stat-number { color: #dc2626; }
    .resumen-stat-label { font-size: 11px; color: #6b7280; margin-top: 4px; }
    .cuentas-btns { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .cuenta-btn { flex: 1; min-width: 80px; padding: 10px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
    .cuenta-btn:hover { border-color: #7c3aed; background: #f5f3ff; }
    .cuenta-btn.active { border-color: #7c3aed; background: #7c3aed; color: white; }
    .resumen-status { padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
    .resumen-status.completo { background: #dcfce7; color: #16a34a; }
    .resumen-status.pendiente { background: #fef3c7; color: #b45309; }
    .resumen-status.vacio { background: #f3f4f6; color: #6b7280; }
    .resumen-pendientes-list { margin-top: 12px; max-height: 200px; overflow-y: auto; }
    .resumen-pendiente-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #fef2f2; border-radius: 6px; margin-bottom: 6px; font-size: 13px; cursor: pointer; }
    .resumen-pendiente-item:hover { background: #fee2e2; }
    .resumen-pendiente-id { font-weight: 600; color: #dc2626; }
    .resumen-pendiente-cuenta { font-size: 11px; color: #6b7280; }
    .resumen-sync-btn { background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .resumen-sync-btn:hover { background: #6d28d9; }
    .resumen-sync-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .resumen-sync-btn .spinner { width: 16px; height: 16px; border: 2px solid #ffffff40; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .resumen-sync-btn.loading .spinner { display: block; }
    .resumen-sync-btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sync-progress { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px; overflow: hidden; display: none; }
    .sync-progress.active { display: block; }
    .sync-progress-bar { height: 100%; background: #7c3aed; border-radius: 2px; animation: progress 2s ease-in-out infinite; width: 30%; }
    @keyframes progress { 0% { margin-left: 0; } 50% { margin-left: 70%; } 100% { margin-left: 0; } }

    /* Login screen */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-overlay.hidden { display: none; }
    .login-box { background: white; border-radius: 16px; padding: 32px; max-width: 360px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-logo { text-align: center; margin-bottom: 24px; }
    .login-logo h1 { font-size: 24px; color: #7c3aed; margin-bottom: 8px; }
    .login-logo p { font-size: 14px; color: #6b7280; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .login-input { padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .login-input:focus { border-color: #7c3aed; }
    .login-btn { padding: 14px 20px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .login-btn:hover { background: #6d28d9; }
    .login-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .login-error { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
    .login-error.show { display: block; }
    .logout-btn { position: fixed; top: 12px; right: 12px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; z-index: 101; transition: background 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .logout-btn.hidden { display: none; }

    /* Link para cambiar de app */
    .app-switch { text-align: center; margin-top: 12px; }
    .app-switch a { color: #7c3aed; font-size: 13px; text-decoration: none; }
    .app-switch a:hover { text-decoration: underline; }

    /* ====== V2 SCREENS ====== */
    .v2-screen { display: none; }
    .v2-screen.active { display: block; }

    /* Order loaded screen */
    .order-header-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .order-header-card h2 { font-size: 18px; font-weight: 700; color: #111827; margin-bottom: 4px; }
    .order-header-card .order-meta { font-size: 13px; color: #6b7280; }
    .order-items-preview { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .order-items-preview h3 { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
    .preview-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
    .preview-item:last-child { border-bottom: none; }
    .preview-item-name { font-size: 14px; color: #111827; font-weight: 500; }
    .preview-item-sku { font-size: 12px; color: #6b7280; font-family: monospace; }
    .preview-item-qty { font-size: 14px; font-weight: 700; color: #7c3aed; background: #f5f3ff; padding: 4px 10px; border-radius: 6px; }
    .start-buttons { display: flex; gap: 12px; }
    .start-btn { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
    .start-btn.fast { background: #059669; color: white; }
    .start-btn.fast:hover { background: #047857; }
    .start-btn.seq { background: #7c3aed; color: white; }
    .start-btn.seq:hover { background: #6d28d9; }

    /* Fast path screen */
    .fast-header { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .fast-header h2 { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 8px; }
    .fast-progress { display: flex; align-items: center; gap: 12px; }
    .fast-progress-bar { flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .fast-progress-fill { height: 100%; background: #22c55e; border-radius: 4px; transition: width 0.3s; }
    .fast-progress-text { font-size: 14px; font-weight: 700; color: #374151; white-space: nowrap; }
    .scan-indicator { text-align: center; padding: 32px 16px; }
    .scan-indicator .scan-anim { font-size: 64px; animation: scanPulse 1.5s ease-in-out infinite; }
    @keyframes scanPulse { 0%,100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }
    .scan-indicator p { font-size: 14px; color: #6b7280; margin-top: 8px; }
    .fast-items-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .fast-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
    .fast-item:last-child { border-bottom: none; }
    .fast-item.complete { background: #f0fdf4; }
    .fast-item-status { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .fast-item-status.pending { background: #f3f4f6; color: #9ca3af; }
    .fast-item-status.partial { background: #fef3c7; color: #d97706; }
    .fast-item-status.done { background: #dcfce7; color: #16a34a; }
    .fast-item-info { flex: 1; min-width: 0; }
    .fast-item-name { font-size: 13px; font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .fast-item-progress { font-size: 12px; color: #6b7280; }
    .fast-actions { display: flex; gap: 8px; margin-top: 16px; }
    .fast-action-btn { flex: 1; padding: 14px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #374151; }
    .fast-action-btn:hover { border-color: #7c3aed; background: #f5f3ff; }

    /* Sequential screen - full height layout */
    #screenSequential { display: flex; flex-direction: column; min-height: calc(100vh - 130px); }
    .seq-header { padding: 12px 0; }
    .seq-progress-row { display: flex; align-items: center; gap: 8px; }
    .seq-progress-bar { flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .seq-progress-fill { height: 100%; background: #7c3aed; border-radius: 3px; transition: width 0.3s; }
    .seq-progress-text { font-size: 13px; font-weight: 600; color: #374151; }

    /* Big product display - centered */
    .seq-product-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 8px 0; }
    .seq-product-name { font-size: 30px; font-weight: 800; color: #111827; line-height: 1.2; margin-bottom: 8px; word-break: break-word; }
    .seq-product-sku { font-family: monospace; font-size: 20px; color: #7c3aed; font-weight: 700; margin-bottom: 20px; }
    .seq-units { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 12px; }
    .seq-unit { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; border: 2px solid #e5e7eb; background: white; color: #9ca3af; }
    .seq-unit.verified { border-color: #22c55e; background: #dcfce7; color: #16a34a; }
    .seq-unit.verified.scan { border-color: #3b82f6; background: #dbeafe; color: #2563eb; }
    .seq-unit.verified.ia { border-color: #f59e0b; background: #fef3c7; color: #d97706; }
    .seq-unit.verified.manual { border-color: #8b5cf6; background: #ede9fe; color: #7c3aed; }
    .seq-status-msg { font-size: 16px; font-weight: 600; padding: 12px 20px; border-radius: 10px; margin-top: 8px; }
    .seq-status-msg.complete { background: #dcfce7; color: #16a34a; }
    .seq-status-msg.inconsistent { background: #fef3c7; color: #92400e; }

    /* Swipe - positioned in lower area */
    .seq-swipe-area { padding: 0 8px; margin-bottom: 100px; }
    .swipe-container { position: relative; height: 60px; background: linear-gradient(90deg, #f3f4f6, #ede9fe); border-radius: 30px; overflow: hidden; }
    .swipe-track { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; }
    .swipe-track-text { font-size: 15px; color: #9ca3af; font-weight: 600; letter-spacing: 0.5px; }
    .swipe-thumb { position: absolute; top: 4px; left: 4px; width: 52px; height: 52px; background: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; cursor: grab; touch-action: none; transition: left 0.1s; z-index: 2; box-shadow: 0 2px 8px rgba(124,58,237,0.3); }
    .swipe-thumb.confirmed { background: #22c55e; box-shadow: 0 2px 8px rgba(34,197,94,0.3); }

    /* Bottom toolbar for sequential */
    .seq-toolbar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 6px 10px; padding-bottom: max(6px, env(safe-area-inset-bottom)); display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; z-index: 90; display: none; }
    .seq-toolbar.show { display: grid; }
    .seq-tool-btn { display: flex; flex-direction: column; align-items: center; gap: 1px; padding: 6px 2px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; font-size: 10px; font-weight: 600; color: #374151; cursor: pointer; transition: all 0.15s; }
    .seq-tool-btn .tool-icon { font-size: 18px; line-height: 1; }
    .seq-tool-btn:active { background: #f5f3ff; border-color: #7c3aed; }
    .seq-tool-btn.warning { color: #d97706; border-color: #fde68a; background: #fffbeb; }
    .seq-tool-btn.warning:active { background: #fef3c7; }
    .seq-tool-usb { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px 2px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; font-size: 10px; font-weight: 600; color: #374151; }
    .seq-tool-usb .usb-toggle { width: 36px; height: 20px; }
    .seq-tool-usb .usb-toggle::after { width: 16px; height: 16px; }
    .seq-tool-usb .usb-toggle.active::after { transform: translateX(16px); }

    /* Panel overlay */
    .panel-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 300; }
    .panel-overlay.show { display: flex; flex-direction: column; justify-content: flex-end; }
    .panel-sheet { background: white; border-radius: 16px 16px 0 0; max-height: 80vh; overflow-y: auto; padding: 20px; padding-bottom: 32px; }
    .panel-handle { width: 40px; height: 4px; background: #d1d5db; border-radius: 2px; margin: 0 auto 16px; }
    .panel-title { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 16px; }
    .panel-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .panel-progress-bar { flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .panel-progress-fill { height: 100%; background: #22c55e; border-radius: 4px; transition: width 0.3s; }
    .panel-progress-pct { font-size: 14px; font-weight: 700; color: #374151; }
    .panel-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
    .panel-item:hover { background: #f9fafb; }
    .panel-item.done { background: #f0fdf4; }
    .panel-item.partial { background: #fffbeb; }
    .panel-item.inconsistent { background: #fef2f2; }
    .panel-item-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .panel-item-dot.green { background: #22c55e; }
    .panel-item-dot.yellow { background: #f59e0b; }
    .panel-item-dot.red { background: #ef4444; }
    .panel-item-dot.gray { background: #d1d5db; }
    .panel-item-info { flex: 1; min-width: 0; }
    .panel-item-name { font-size: 13px; font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .panel-item-detail { font-size: 12px; color: #6b7280; }
    .panel-item-methods { display: flex; gap: 4px; }
    .panel-resolve-btn { padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .panel-btn-open { position: fixed; bottom: 70px; right: 16px; width: 48px; height: 48px; background: #7c3aed; color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 95; box-shadow: 0 4px 12px rgba(124,58,237,0.4); display: none; }
    .panel-btn-open.show { display: flex; align-items: center; justify-content: center; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .panel-edit-btn { padding: 5px 12px; border: 2px solid #7c3aed; background: white; color: #7c3aed; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .panel-edit-btn.active { background: #7c3aed; color: white; }
    .panel-item-actions { display: none; align-items: center; gap: 6px; margin-left: auto; }
    .panel-item.editing .panel-item-actions { display: flex; }
    .panel-item-del { width: 24px; height: 24px; border-radius: 50%; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .panel-item-del:active { background: #dc2626; color: white; }
    .panel-qty-btn { width: 26px; height: 26px; border-radius: 50%; border: 1px solid #e5e7eb; background: white; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #374151; }
    .panel-qty-btn:active { border-color: #7c3aed; background: #f5f3ff; }
    .panel-qty-val { font-size: 13px; font-weight: 700; color: #374151; min-width: 18px; text-align: center; }
    .panel-add-btn { width: 100%; padding: 10px; border: 2px dashed #d1d5db; background: #f9fafb; color: #6b7280; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 8px; margin-top: 8px; display: none; }
    .panel-add-btn:active { border-color: #7c3aed; color: #7c3aed; }
    .panel-add-btn.show { display: block; }

    /* Resolve modal */
    .resolve-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 400; align-items: center; justify-content: center; padding: 20px; }
    .resolve-modal.show { display: flex; }
    .resolve-modal .modal { max-width: 400px; }
    .resolve-options { display: flex; gap: 8px; margin-bottom: 12px; }
    .resolve-option { flex: 1; padding: 10px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; }
    .resolve-option.selected { border-color: #7c3aed; background: #f5f3ff; }
    .resolve-textarea { width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical; margin-bottom: 12px; }
    .resolve-textarea:focus { outline: none; border-color: #7c3aed; }
    .resolve-char-count { font-size: 12px; color: #9ca3af; margin-bottom: 12px; }

    /* Complete screen */
    .complete-card { background: white; border-radius: 16px; padding: 32px 24px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .complete-icon { font-size: 64px; margin-bottom: 16px; }
    .complete-title { font-size: 22px; font-weight: 700; color: #111827; margin-bottom: 8px; }
    .complete-subtitle { font-size: 14px; color: #6b7280; margin-bottom: 24px; }
    .complete-stats { display: flex; gap: 12px; margin-bottom: 24px; justify-content: center; }
    .complete-stat { text-align: center; padding: 12px 16px; background: #f9fafb; border-radius: 10px; min-width: 80px; }
    .complete-stat-val { font-size: 20px; font-weight: 700; color: #7c3aed; }
    .complete-stat-label { font-size: 11px; color: #6b7280; margin-top: 2px; }
    .complete-faltantes { text-align: left; background: #fef2f2; border-radius: 10px; padding: 12px; margin-bottom: 16px; }
    .complete-faltantes h4 { font-size: 14px; color: #dc2626; margin-bottom: 8px; }
    .complete-faltante-item { font-size: 13px; color: #374151; padding: 4px 0; }
    .complete-close-btn { width: 100%; padding: 16px; background: #22c55e; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; }
    .complete-close-btn:hover { background: #16a34a; }

    /* Camera in v2 */
    .v2-camera-container { position: relative; margin-bottom: 16px; border-radius: 12px; overflow: hidden; background: black; }
    .v2-camera-container video { width: 100%; display: block; }
    .v2-camera-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }
    .v2-camera-container.frozen canvas { display: block; }

    /* Importar pedido específico */
    .import-section { background: #f9fafb; border-radius: 8px; padding: 12px; margin-top: 16px; border: 1px dashed #d1d5db; }
    .import-section-title { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .import-input-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .import-account-select { padding: 10px 12px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; min-width: 100px; }
    .import-account-select:focus { outline: none; border-color: #7c3aed; }
    .import-input { flex: 1; padding: 10px 12px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 6px; }
    .import-input:focus { outline: none; border-color: #7c3aed; }
    .import-btn { padding: 10px 16px; background: #7c3aed; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .import-btn:hover { background: #6d28d9; }
    .import-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .import-result { margin-top: 8px; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: none; }
    .import-result.show { display: block; }
    .import-result.success { background: #dcfce7; color: #16a34a; }
    .import-result.error { background: #fef2f2; color: #dc2626; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-logo">
        <h1>Verificador Mayorista</h1>
        <p>Inicia sesion para continuar</p>
      </div>
      <form class="login-form" id="loginForm">
        <input type="text" class="login-input" id="loginUser" placeholder="Usuario" autocomplete="username" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Contrasena" autocomplete="current-password" required>
        <div class="login-error" id="loginError">Usuario o contrasena incorrectos</div>
        <button type="submit" class="login-btn" id="loginBtn">Iniciar Sesion</button>
      </form>
    </div>
  </div>

  <!-- Logout Button -->
  <button type="button" class="logout-btn hidden" id="logoutBtn">Salir</button>

  <div class="header">
    <h1>Verificador Mayorista</h1>
    <div class="nav-tabs">
      <button type="button" class="nav-tab active" id="navPanel" data-view="panel">Panel</button>
      <button type="button" class="nav-tab" id="navVerificar" data-view="verificar">Verificar</button>
    </div>
  </div>
  <div class="container">
    <!-- Vista Panel -->
    <div class="view-section active" id="viewPanel">
      <div class="resumen-section" id="resumenSection">
        <div class="resumen-header">
          <h2 id="resumenTitulo">Pedidos del Dia</h2>
          <span class="resumen-fecha" id="resumenFecha">--/--/----</span>
        </div>
        <div class="resumen-stats">
          <div class="resumen-stat total">
            <div class="resumen-stat-number" id="resumenTotal">-</div>
            <div class="resumen-stat-label">TOTAL</div>
          </div>
          <div class="resumen-stat verificados">
            <div class="resumen-stat-number" id="resumenVerificados">-</div>
            <div class="resumen-stat-label">VERIF</div>
          </div>
          <div class="resumen-stat pendientes">
            <div class="resumen-stat-number" id="resumenPendientes">-</div>
            <div class="resumen-stat-label">PEND</div>
          </div>
        </div>
        <div class="resumen-status vacio" id="resumenStatus">Cargando...</div>
        <div class="cuentas-btns" id="cuentasBtns"></div>
        <div class="resumen-pendientes-list hidden" id="resumenPendientesList"></div>
        <div style="text-align: center; margin-top: 12px;">
          <button type="button" class="resumen-sync-btn" id="resumenSync">
            <span class="spinner"></span>
            <span class="btn-text">Sincronizar Jumpseller</span>
          </button>
          <div class="sync-progress" id="syncProgress">
            <div class="sync-progress-bar"></div>
          </div>
        </div>

        <!-- Importar pedido específico -->
        <div class="import-section">
          <div class="import-section-title">Importar pedido específico</div>
          <div class="import-input-group">
            <select class="import-account-select" id="importAccountSelect">
              <option value="">Todas las cuentas</option>
            </select>
            <input type="text" class="import-input" id="importOrderInput" placeholder="Número de orden...">
            <button type="button" class="import-btn" id="importOrderBtn">Importar</button>
          </div>
          <div class="import-result" id="importResult"></div>
        </div>

        <div class="app-switch">
          <a href="/">Cambiar a MercadoLibre</a>
        </div>
      </div>
    </div>

    <!-- Vista Verificar V2 -->
    <div class="view-section" id="viewVerificar">
      <div class="status-message" id="statusMessage"></div>

      <!-- Screen: Buscar orden -->
      <div class="v2-screen active" id="screenOrderSearch">
        <div class="scan-section">
          <div class="scan-input-group">
            <input type="text" id="orderInput" class="scan-input" placeholder="Numero de orden...">
            <button type="button" id="searchBtn" class="scan-btn">Buscar</button>
          </div>
        </div>
      </div>

      <!-- Screen: Orden cargada -->
      <div class="v2-screen" id="screenOrderLoaded">
        <div class="order-header-card">
          <h2 id="orderTitle">Orden #---</h2>
          <div class="order-meta" id="orderMeta"></div>
        </div>
        <div class="order-items-preview" id="orderItemsPreview">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3>Items del pedido</h3>
            <button type="button" class="edit-mode-btn" id="editModeBtn">Editar</button>
          </div>
          <div id="previewItemsList"></div>
          <button type="button" class="add-item-btn" id="addItemBtn">+ Agregar producto</button>
        </div>
        <div class="start-buttons">
          <button type="button" class="start-btn fast" id="startFastBtn">Escaneo rapido</button>
          <button type="button" class="start-btn seq" id="startSeqBtn">Secuencial</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button type="button" class="reset-btn" id="resetBtn" style="flex:1;margin-top:0">Cambiar orden</button>
          <button type="button" class="reset-btn" id="deleteOrderBtn" style="flex:1;margin-top:0;background:#dc2626">Eliminar orden</button>
        </div>
      </div>

      <!-- Screen: Fast path -->
      <div class="v2-screen" id="screenFastPath">
        <div class="fast-header">
          <h2 id="fastTitle">Escaneo rapido</h2>
          <div class="fast-progress">
            <div class="fast-progress-bar"><div class="fast-progress-fill" id="fastProgressFill" style="width:0%"></div></div>
            <span class="fast-progress-text" id="fastProgressText">0/0</span>
          </div>
        </div>
        <div class="scan-indicator" id="fastScanIndicator">
          <div class="scan-anim">&#128225;</div>
          <p>Escaneá productos con camara o lector USB</p>
        </div>
        <div class="fast-items-list" id="fastItemsList"></div>
        <div class="fast-actions">
          <button type="button" class="fast-action-btn" id="fastToSeqBtn">Ir a secuencial</button>
          <button type="button" class="fast-action-btn" id="fastPanelBtn">Panel</button>
        </div>
      </div>

      <!-- Screen: Sequential -->
      <div class="v2-screen" id="screenSequential">
        <div class="seq-header">
          <div class="seq-progress-row">
            <div class="seq-progress-bar"><div class="seq-progress-fill" id="seqProgressFill" style="width:0%"></div></div>
            <span class="seq-progress-text" id="seqProgressText">Item 1/1</span>
          </div>
        </div>
        <div class="seq-product-display" id="seqItemContainer"></div>
        <div class="seq-swipe-area" id="seqSwipeArea"></div>
      </div>

      <!-- Screen: Complete -->
      <div class="v2-screen" id="screenComplete">
        <div class="complete-card">
          <div class="complete-icon">&#9989;</div>
          <div class="complete-title">Pedido verificado</div>
          <div class="complete-subtitle" id="completeSubtitle">Todos los items fueron verificados</div>
          <div class="complete-stats" id="completeStats"></div>
          <div class="complete-faltantes hidden" id="completeFaltantes">
            <h4>Faltantes confirmados</h4>
            <div id="completeFaltantesList"></div>
          </div>
          <button type="button" class="complete-close-btn" id="completeCloseBtn">Cerrar pedido</button>
        </div>
      </div>

      <!-- Camera container (shared) -->
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <canvas id="capturedOverlay"></canvas>
        <div class="photo-thumbnails" id="photoThumbnails"></div>
        <button type="button" class="close-camera" id="closeCamera">X</button>
        <button type="button" class="capture-photo-btn" id="capturePhotoBtn">Analizar con IA</button>
      </div>
      <div class="multi-photo-bar" id="multiPhotoBar">
        <button type="button" class="btn-otra-foto" id="btnOtraFoto">+ Otra foto</button>
        <button type="button" class="btn-enviar-analisis" id="btnEnviarAnalisis">Enviar analisis</button>
      </div>
    </div>
  </div>

  <!-- Banner de escaneo exitoso -->
  <div class="scan-success-banner" id="scanSuccessBanner">
    <div class="scan-icon">&#10003;</div>
    <div class="scan-text" id="scanSuccessText">Escaneado</div>
    <div class="scan-sku" id="scanSuccessSku"></div>
    <div class="scan-count" id="scanSuccessCount"></div>
  </div>

  <!-- Banner de error de escaneo -->
  <div class="scan-error-banner" id="scanErrorBanner">
    <div class="scan-icon">&#10007;</div>
    <div class="scan-text" id="scanErrorText">Error</div>
  </div>

  <!-- USB Scanner -->
  <input type="text" id="usbScannerInput" class="usb-scanner-input hidden" placeholder="Esperando lector USB..." autocomplete="off">
  <div class="usb-toggle-container" id="usbToggleContainer">
    <span class="usb-toggle-label">Lector USB</span>
    <button type="button" id="usbToggle" class="usb-toggle" title="Alternar lector USB externo"></button>
  </div>
  <button type="button" id="cameraBtn" class="camera-btn hidden">Escanear</button>

  <!-- Sequential toolbar -->
  <div class="seq-toolbar" id="seqToolbar">
    <button type="button" class="seq-tool-btn" id="seqScanBtn"><span class="tool-icon">&#128225;</span>Escanear</button>
    <button type="button" class="seq-tool-btn" id="seqIaBtn"><span class="tool-icon">&#128247;</span>Foto IA</button>
    <button type="button" class="seq-tool-btn" id="seqFastBtn"><span class="tool-icon">&#9889;</span>Esc. rapido</button>
    <button type="button" class="seq-tool-btn" id="seqOrdenBtn"><span class="tool-icon">&#9776;</span>Orden</button>
    <button type="button" class="seq-tool-btn warning" id="seqIncBtn"><span class="tool-icon">&#9888;</span>Inconsist.</button>
    <div class="seq-tool-usb">
      <span>USB</span>
      <button type="button" id="seqUsbToggle" class="usb-toggle" title="Lector USB"></button>
    </div>
  </div>

  <!-- Panel overlay (bottom sheet) -->
  <button type="button" class="panel-btn-open" id="panelBtnOpen">&#9776;</button>
  <div class="panel-overlay" id="panelOverlay">
    <div class="panel-sheet">
      <div class="panel-handle"></div>
      <div class="panel-header">
        <div class="panel-title" style="margin-bottom:0">Estado del pedido</div>
        <button type="button" class="panel-edit-btn" id="panelEditBtn">Editar</button>
      </div>
      <div class="panel-progress">
        <div class="panel-progress-bar"><div class="panel-progress-fill" id="panelProgressFill" style="width:0%"></div></div>
        <span class="panel-progress-pct" id="panelProgressPct">0%</span>
      </div>
      <div id="panelItemsList"></div>
      <button type="button" class="panel-add-btn" id="panelAddBtn">+ Agregar producto</button>
    </div>
  </div>

  <!-- Modal para guardar barcode -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3>Codigo no registrado</h3>
      <p>Este codigo de barras no esta vinculado a ningun SKU. Selecciona el producto correspondiente para guardarlo:</p>
      <div class="modal-barcode" id="modalBarcode"></div>
      <div class="modal-sku-list" id="modalSkuList"></div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn secondary" id="modalCancel">Cancelar</button>
        <button type="button" class="modal-btn primary" id="modalSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal para agregar producto -->
  <div class="modal-overlay" id="addItemModalOverlay">
    <div class="modal">
      <h3>Agregar producto</h3>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <input type="text" id="addItemSku" class="login-input" placeholder="SKU (ej: FT-A15)" style="font-family:monospace;">
        <input type="text" id="addItemName" class="login-input" placeholder="Nombre del producto">
        <div style="display:flex;align-items:center;gap:12px;">
          <label style="font-size:14px;color:#374151;font-weight:600;">Cantidad:</label>
          <input type="number" id="addItemQty" class="login-input" value="1" min="1" style="width:80px;text-align:center;">
        </div>
      </div>
      <div class="modal-buttons" style="margin-top:16px;">
        <button type="button" class="modal-btn secondary" id="addItemCancel">Cancelar</button>
        <button type="button" class="modal-btn primary" id="addItemConfirm">Agregar</button>
      </div>
    </div>
  </div>

  <!-- Modal resolver inconsistencia -->
  <div class="resolve-modal" id="resolveModal">
    <div class="modal">
      <h3 id="resolveTitle">Resolver inconsistencia</h3>
      <p id="resolveItemInfo"></p>
      <div class="resolve-options">
        <button type="button" class="resolve-option selected" id="resolveOptResolve" data-action="resolver">Resolver</button>
        <button type="button" class="resolve-option" id="resolveOptFaltante" data-action="confirmar_faltante">Confirmar faltante</button>
      </div>
      <textarea class="resolve-textarea" id="resolveNota" placeholder="Escribe una nota (minimo 10 caracteres)..."></textarea>
      <div class="resolve-char-count" id="resolveCharCount">0/10</div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn secondary" id="resolveCancelBtn">Cancelar</button>
        <button type="button" class="modal-btn primary" id="resolveConfirmBtn" disabled>Confirmar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    // ============================================
    // SISTEMA DE AUTENTICACION
    // ============================================
    (function authInit() {
      var loginOverlay = document.getElementById('loginOverlay');
      var loginForm = document.getElementById('loginForm');
      var loginUser = document.getElementById('loginUser');
      var loginPassword = document.getElementById('loginPassword');
      var loginError = document.getElementById('loginError');
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');

      function checkAuth() {
        return fetch('/api/auth/check', { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.authenticated) {
              showApp();
              return true;
            } else {
              showLogin();
              return false;
            }
          })
          .catch(function() {
            showLogin();
            return false;
          });
      }

      function showLogin() {
        loginOverlay.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        loginUser.focus();
      }

      function showApp() {
        loginOverlay.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        if (typeof initMainApp === 'function') {
          initMainApp();
        }
      }

      loginForm.onsubmit = function(e) {
        e.preventDefault();
        loginError.classList.remove('show');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Ingresando...';

        fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            username: loginUser.value,
            password: loginPassword.value
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';
          if (data.success) {
            loginPassword.value = '';
            showApp();
          } else {
            loginError.textContent = data.error || 'Error al iniciar sesion';
            loginError.classList.add('show');
          }
        })
        .catch(function(err) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';
          loginError.textContent = 'Error de conexion';
          loginError.classList.add('show');
        });
      };

      logoutBtn.onclick = function() {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
        .then(function() { showLogin(); })
        .catch(function() { showLogin(); });
      };

      checkAuth();
    })();

    // Registrar Service Worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(function(reg) {
        console.log('Service Worker registrado');
      }).catch(function(err) {
        console.log('Error registrando SW:', err);
      });
    }

    // ============================================
    // APP PRINCIPAL MAYORISTA
    // ============================================
    var mainAppInitialized = false;
    function initMainApp() {
      if (mainAppInitialized) return;
      mainAppInitialized = true;

      var API_URL = '';

      function authFetch(url, options) {
        options = options || {};
        options.credentials = 'include';
        return fetch(url, options).then(function(response) {
          if (response.status === 401) {
            window.location.reload();
            return Promise.reject(new Error('Sesion expirada'));
          }
          return response;
        });
      }

      // ============================================
      // ESTADO V2
      // ============================================
      var currentOrderId = '';
      var currentAccount = '';
      var currentItems = [];          // items del pedido
      var unitMethods = {};           // unitMethods[itemIdx] = ['scan','scan','ia','manual']
      var orderState = 'pending_verification';
      var verificationPath = null;    // scan_only | sequential | mixed
      var timestampInicio = null;
      var codigosDesconocidos = [];
      var currentScreen = 'order-search';
      var sequentialIndex = 0;
      var codeReader = null;
      var isScanning = false;
      var pendingBarcode = null;
      var selectedSkuForModal = null;
      var productoAVerificar = null;

      // DOM refs
      var orderInput = document.getElementById('orderInput');
      var searchBtn = document.getElementById('searchBtn');
      var cameraBtn = document.getElementById('cameraBtn');
      var cameraContainer = document.getElementById('cameraContainer');
      var closeCameraBtn = document.getElementById('closeCamera');
      var video = document.getElementById('video');
      var statusMessage = document.getElementById('statusMessage');
      var resetBtn = document.getElementById('resetBtn');

      var navPanel = document.getElementById('navPanel');
      var navVerificar = document.getElementById('navVerificar');
      var viewPanel = document.getElementById('viewPanel');
      var viewVerificar = document.getElementById('viewVerificar');
      var currentView = 'panel';

      var modalOverlay = document.getElementById('modalOverlay');
      var modalBarcode = document.getElementById('modalBarcode');
      var modalSkuList = document.getElementById('modalSkuList');
      var modalCancel = document.getElementById('modalCancel');
      var modalSave = document.getElementById('modalSave');

      // Vision/IA
      var capturePhotoBtn = document.getElementById('capturePhotoBtn');

      // V2 screens
      var screens = {
        'order-search': document.getElementById('screenOrderSearch'),
        'order-loaded': document.getElementById('screenOrderLoaded'),
        'fast-path': document.getElementById('screenFastPath'),
        'sequential': document.getElementById('screenSequential'),
        'complete': document.getElementById('screenComplete')
      };

      var panelBtnOpen = document.getElementById('panelBtnOpen');
      var panelOverlay = document.getElementById('panelOverlay');

      // ============================================
      // NAVEGACION
      // ============================================
      function switchView(view) {
        currentView = view;
        if (view === 'panel') {
          viewPanel.classList.add('active');
          viewVerificar.classList.remove('active');
          navPanel.classList.add('active');
          navVerificar.classList.remove('active');
          cameraBtn.classList.add('hidden');
          panelBtnOpen.classList.remove('show');
        } else {
          viewPanel.classList.remove('active');
          viewVerificar.classList.add('active');
          navPanel.classList.remove('active');
          navVerificar.classList.add('active');
        }
      }

      var usbToggleContainer = document.getElementById('usbToggleContainer');

      var seqToolbar = document.getElementById('seqToolbar');

      function switchScreen(name) {
        currentScreen = name;
        Object.keys(screens).forEach(function(k) {
          if (screens[k]) screens[k].classList.remove('active');
        });
        if (screens[name]) screens[name].classList.add('active');

        // Show/hide elements based on screen
        if (name === 'fast-path') {
          cameraBtn.classList.remove('hidden');
          cameraBtn.textContent = 'Escanear producto';
          cameraBtn.className = 'camera-btn product-mode';
          panelBtnOpen.classList.add('show');
          usbToggleContainer.classList.add('show');
          seqToolbar.classList.remove('show');
        } else if (name === 'sequential') {
          // Sequential: toolbar has everything, hide the big camera btn and floating panel/usb
          cameraBtn.classList.add('hidden');
          panelBtnOpen.classList.remove('show');
          usbToggleContainer.classList.remove('show');
          seqToolbar.classList.add('show');
        } else {
          cameraBtn.classList.add('hidden');
          panelBtnOpen.classList.remove('show');
          usbToggleContainer.classList.remove('show');
          seqToolbar.classList.remove('show');
        }
      }

      navPanel.onclick = function() { switchView('panel'); };
      navVerificar.onclick = function() { switchView('verificar'); };

      // ============================================
      // RESUMEN DEL DIA
      // ============================================
      var resumenFecha = document.getElementById('resumenFecha');
      var resumenTotal = document.getElementById('resumenTotal');
      var resumenVerificados = document.getElementById('resumenVerificados');
      var resumenPendientes = document.getElementById('resumenPendientes');
      var resumenStatus = document.getElementById('resumenStatus');
      var resumenPendientesList = document.getElementById('resumenPendientesList');
      var cuentasBtns = document.getElementById('cuentasBtns');
      var resumenSync = document.getElementById('resumenSync');
      var syncProgress = document.getElementById('syncProgress');

      function cargarResumenDia() {
        authFetch(API_URL + '/api/mayorista/resumen')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Error');

            resumenFecha.textContent = data.fecha;
            resumenTotal.textContent = data.estadisticas.total;
            resumenVerificados.textContent = data.estadisticas.verificados;
            resumenPendientes.textContent = data.estadisticas.pendientes;

            // Estado
            if (data.estadisticas.total === 0) {
              resumenStatus.className = 'resumen-status vacio';
              resumenStatus.textContent = 'Sin pedidos para hoy';
            } else if (data.estadisticas.pendientes === 0) {
              resumenStatus.className = 'resumen-status completo';
              resumenStatus.textContent = 'Todos los pedidos verificados';
            } else {
              resumenStatus.className = 'resumen-status pendiente';
              resumenStatus.textContent = data.estadisticas.pendientes + ' pedidos pendientes';
            }

            // Botones de cuentas
            cuentasBtns.innerHTML = '';
            var cuentas = Object.keys(data.porCuenta || {});
            cuentas.forEach(function(cuenta) {
              var info = data.porCuenta[cuenta];
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'cuenta-btn';
              btn.textContent = cuenta + ' (' + info.pendientes + '/' + info.total + ')';
              btn.onclick = function() {
                // Podría filtrar por cuenta
              };
              cuentasBtns.appendChild(btn);
            });

            // Lista de pendientes
            if (data.pendientes && data.pendientes.length > 0) {
              resumenPendientesList.classList.remove('hidden');
              resumenPendientesList.innerHTML = '';
              data.pendientes.forEach(function(p) {
                var item = document.createElement('div');
                item.className = 'resumen-pendiente-item';
                item.innerHTML = '<span class="resumen-pendiente-id">#' + p.orderId + '</span>' +
                  '<span class="resumen-pendiente-cuenta">' + (p.cuenta || '') + ' - ' + (p.cliente || '') + '</span>';
                item.onclick = function() {
                  orderInput.value = p.orderId;
                  searchOrder(p.orderId);
                };
                resumenPendientesList.appendChild(item);
              });
            } else {
              resumenPendientesList.classList.add('hidden');
            }
          })
          .catch(function(err) {
            console.error('Error cargando resumen:', err);
            resumenStatus.className = 'resumen-status vacio';
            resumenStatus.textContent = 'Error cargando datos';
          });
      }

      // Sincronizar
      resumenSync.onclick = function() {
        resumenSync.disabled = true;
        resumenSync.classList.add('loading');
        syncProgress.classList.add('active');

        authFetch(API_URL + '/api/mayorista/sync')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) {
              showStatus('Sincronizado: ' + data.total + ' pedidos', 'success');
            } else {
              showStatus(data.mensaje || 'Error sincronizando', 'error');
            }
            cargarResumenDia();
          })
          .catch(function(err) {
            showStatus('Error: ' + err.message, 'error');
          })
          .finally(function() {
            resumenSync.disabled = false;
            resumenSync.classList.remove('loading');
            syncProgress.classList.remove('active');
          });
      };

      // Cargar resumen inicial
      cargarResumenDia();

      // ============================================
      // IMPORTAR PEDIDO ESPECÍFICO
      // ============================================
      var importOrderInput = document.getElementById('importOrderInput');
      var importOrderBtn = document.getElementById('importOrderBtn');
      var importResult = document.getElementById('importResult');
      var importAccountSelect = document.getElementById('importAccountSelect');

      // Cargar cuentas disponibles en el selector
      function loadImportAccounts() {
        authFetch(API_URL + '/api/mayorista/accounts')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success && data.cuentas) {
              importAccountSelect.innerHTML = '<option value="">Todas las cuentas</option>';
              data.cuentas.forEach(function(c) {
                var opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = c.name;
                importAccountSelect.appendChild(opt);
              });
            }
          })
          .catch(function() {});
      }
      loadImportAccounts();

      function showImportResult(message, type) {
        importResult.textContent = message;
        importResult.className = 'import-result show ' + type;
        if (type === 'success') {
          setTimeout(function() {
            importResult.className = 'import-result';
          }, 5000);
        }
      }

      function importOrder() {
        var orderId = importOrderInput.value.trim();
        if (!orderId) {
          showImportResult('Ingresá un número de orden', 'error');
          return;
        }

        importOrderBtn.disabled = true;
        importOrderBtn.textContent = 'Importando...';
        importResult.className = 'import-result';

        var cuentaSeleccionada = importAccountSelect.value;
        authFetch(API_URL + '/api/mayorista/import/' + orderId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cuenta: cuentaSeleccionada || '' })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            if (data.yaExistia) {
              showImportResult('La orden #' + orderId + ' ya estaba importada', 'success');
            } else {
              showImportResult('Orden #' + orderId + ' importada de ' + data.cuenta, 'success');
            }
            importOrderInput.value = '';
            cargarResumenDia();
          } else {
            showImportResult(data.error || 'Error importando orden', 'error');
          }
        })
        .catch(function(err) {
          showImportResult('Error: ' + err.message, 'error');
        })
        .finally(function() {
          importOrderBtn.disabled = false;
          importOrderBtn.textContent = 'Importar';
        });
      }

      importOrderBtn.onclick = importOrder;
      importOrderInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') importOrder();
      });

      // ============================================
      // UTILIDADES
      // ============================================
      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message show ' + type;
        if (type === 'success') {
          setTimeout(hideStatus, 3000);
        }
      }

      function hideStatus() {
        statusMessage.className = 'status-message';
      }

      function getVerifiedCount(itemIndex) {
        var methods = unitMethods[itemIndex] || [];
        return methods.length;
      }

      function isItemComplete(itemIndex) {
        var item = currentItems[itemIndex];
        return getVerifiedCount(itemIndex) >= item.quantity;
      }

      function getTotalVerifiedUnits() {
        var total = 0;
        for (var i = 0; i < currentItems.length; i++) {
          total += getVerifiedCount(i);
        }
        return total;
      }

      function getTotalUnits() {
        var total = 0;
        for (var i = 0; i < currentItems.length; i++) {
          total += currentItems[i].quantity;
        }
        return total;
      }

      function allItemsComplete() {
        for (var i = 0; i < currentItems.length; i++) {
          if (!isItemComplete(i) && currentItems[i].inconsistencia !== 'faltante_confirmado') return false;
        }
        return true;
      }

      // ============================================
      // STATE MACHINE
      // ============================================
      function transitionState(newState) {
        var valid = {
          'pending_verification': ['verifying_scan_only', 'verifying_sequential'],
          'verifying_scan_only': ['verifying_sequential', 'verified_scan_only'],
          'verifying_sequential': ['verified_sequential', 'blocked_inconsistency'],
          'blocked_inconsistency': ['verified_sequential']
        };

        var allowed = valid[orderState] || [];
        if (allowed.indexOf(newState) === -1) {
          console.warn('Transicion no valida: ' + orderState + ' -> ' + newState);
          return;
        }

        orderState = newState;

        // Sync to backend
        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId + '/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            estado: orderState,
            camino: verificationPath || '',
            timestampInicio: timestampInicio || '',
            codigosDesconocidos: codigosDesconocidos
          })
        }).catch(function(err) { console.error('Error syncing state:', err); });

        // Update UI based on new state
        if (newState === 'verified_scan_only' || newState === 'verified_sequential') {
          showCompleteScreen();
        } else if (newState === 'blocked_inconsistency') {
          showStatus('Pedido bloqueado: hay inconsistencias pendientes', 'error');
        }
      }

      // ============================================
      // SAVE ITEM VERIFICATION
      // ============================================
      function saveItemVerification(itemIndex, metodo) {
        var item = currentItems[itemIndex];
        if (!item || !currentOrderId) return;

        var methods = unitMethods[itemIndex] || [];

        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId + '/item/verificar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sku: item.sku,
            verificados: methods.length,
            metodo: metodo,
            metodoPorUnidad: methods
          })
        }).catch(function(err) { console.error('Error guardando verificacion:', err); });
      }

      // ============================================
      // BUSCAR ORDEN
      // ============================================
      function searchOrder(orderId) {
        if (!orderId || orderId.trim() === '') {
          showStatus('Ingresa un numero de orden', 'error');
          return;
        }
        showStatus('Buscando orden...', 'loading');
        searchBtn.disabled = true;
        searchBtn.textContent = '...';

        authFetch(API_URL + '/api/mayorista/order/' + orderId.trim() + '/items')
          .then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) throw new Error(data.error || 'Error al buscar orden');
              return data;
            });
          })
          .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Orden no encontrada');
            if (!data.items || data.items.length === 0) throw new Error('Orden sin items');

            currentOrderId = orderId.trim();
            currentAccount = data.items[0].cuenta || '';

            // Build items and restore state
            currentItems = [];
            unitMethods = {};

            data.items.forEach(function(item, index) {
              currentItems.push({
                sku: item.sku || '',
                name: item.nombre || item.name || '',
                quantity: item.cantidad || 1,
                inconsistencia: item.inconsistencia || '',
                resolucionInfo: item.resolucionInfo || null
              });

              // Restore per-unit methods
              if (item.metodoPorUnidad && item.metodoPorUnidad.length > 0) {
                unitMethods[index] = item.metodoPorUnidad.slice();
              } else {
                // Fallback: fill from verificados count
                unitMethods[index] = [];
                var v = item.verificados || 0;
                for (var j = 0; j < v; j++) {
                  unitMethods[index].push(item.metodo || 'restored');
                }
              }
            });

            // Restore order state
            if (data.orderState) {
              orderState = data.orderState.estadoVerif || 'pending_verification';
              verificationPath = data.orderState.camino || null;
              timestampInicio = data.orderState.timestampInicio || null;
              try {
                codigosDesconocidos = data.orderState.codigosDesconocidos ? JSON.parse(data.orderState.codigosDesconocidos) : [];
              } catch(e) { codigosDesconocidos = []; }
            } else {
              orderState = 'pending_verification';
              verificationPath = null;
              timestampInicio = null;
              codigosDesconocidos = [];
            }

            sequentialIndex = 0;
            hideStatus();
            stopCamera();
            switchView('verificar');

            // Decide which screen to show based on restored state
            if (orderState === 'verified_scan_only' || orderState === 'verified_sequential') {
              showCompleteScreen();
            } else if (orderState === 'verifying_scan_only') {
              switchScreen('fast-path');
              renderFastPath();
            } else if (orderState === 'verifying_sequential' || orderState === 'blocked_inconsistency') {
              switchScreen('sequential');
              renderSequentialItem();
            } else {
              showOrderLoadedScreen();
            }
          })
          .catch(function(error) {
            showStatus(error.message, 'error');
          })
          .finally(function() {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Buscar';
          });
      }

      searchBtn.onclick = function() { searchOrder(orderInput.value); };
      orderInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchOrder(orderInput.value);
      });

      // ============================================
      // ORDER LOADED SCREEN
      // ============================================
      var editMode = false;
      var editModeBtn = document.getElementById('editModeBtn');
      var addItemBtn = document.getElementById('addItemBtn');

      function showOrderLoadedScreen() {
        switchScreen('order-loaded');
        editMode = false;
        editModeBtn.textContent = 'Editar';
        editModeBtn.classList.remove('active');
        addItemBtn.classList.remove('show');
        document.getElementById('orderTitle').textContent = 'Orden #' + currentOrderId;
        document.getElementById('orderMeta').textContent = currentAccount;
        renderPreviewItems();
      }

      function renderPreviewItems() {
        var list = document.getElementById('previewItemsList');
        list.innerHTML = '';
        currentItems.forEach(function(item, idx) {
          var div = document.createElement('div');
          div.className = 'preview-item' + (editMode ? ' editing' : '');

          var topRow = document.createElement('div');
          topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;width:100%;';
          topRow.innerHTML = '<div><div class="preview-item-name">' + (item.name || item.sku) + '</div>' +
            '<div class="preview-item-sku">' + (item.sku || '') + '</div></div>' +
            '<div class="preview-item-qty">x' + item.quantity + '</div>';
          div.appendChild(topRow);

          // Edit controls (only visible in edit mode)
          var actions = document.createElement('div');
          actions.className = 'preview-item-actions';

          var delBtn = document.createElement('button');
          delBtn.className = 'preview-delete-btn';
          delBtn.textContent = '\u00D7';
          delBtn.title = 'Eliminar';
          delBtn.setAttribute('data-idx', idx);
          delBtn.onclick = function(e) {
            e.stopPropagation();
            var i = parseInt(this.getAttribute('data-idx'));
            var it = currentItems[i];
            if (!confirm('Eliminar "' + (it.name || it.sku) + '"?')) return;
            currentItems.splice(i, 1);
            // Reindex unitMethods
            var newMethods = {};
            for (var k = 0; k < currentItems.length; k++) {
              newMethods[k] = k < i ? (unitMethods[k] || []) : (unitMethods[k + 1] || []);
            }
            unitMethods = newMethods;
            renderPreviewItems();
          };
          actions.appendChild(delBtn);

          var minusBtn = document.createElement('button');
          minusBtn.className = 'qty-btn';
          minusBtn.textContent = '\u2212';
          minusBtn.setAttribute('data-idx', idx);
          minusBtn.onclick = function(e) {
            e.stopPropagation();
            var i = parseInt(this.getAttribute('data-idx'));
            if (currentItems[i].quantity > 1) {
              currentItems[i].quantity--;
              var methods = unitMethods[i] || [];
              if (methods.length > currentItems[i].quantity) {
                unitMethods[i] = methods.slice(0, currentItems[i].quantity);
              }
              renderPreviewItems();
            }
          };
          actions.appendChild(minusBtn);

          var qtyLabel = document.createElement('span');
          qtyLabel.className = 'qty-display';
          qtyLabel.textContent = item.quantity;
          actions.appendChild(qtyLabel);

          var plusBtn = document.createElement('button');
          plusBtn.className = 'qty-btn';
          plusBtn.textContent = '+';
          plusBtn.setAttribute('data-idx', idx);
          plusBtn.onclick = function(e) {
            e.stopPropagation();
            var i = parseInt(this.getAttribute('data-idx'));
            currentItems[i].quantity++;
            renderPreviewItems();
          };
          actions.appendChild(plusBtn);

          div.appendChild(actions);
          list.appendChild(div);
        });
      }

      editModeBtn.onclick = function() {
        editMode = !editMode;
        editModeBtn.textContent = editMode ? 'Listo' : 'Editar';
        editModeBtn.classList.toggle('active', editMode);
        if (editMode) { addItemBtn.classList.add('show'); } else { addItemBtn.classList.remove('show'); }
        renderPreviewItems();
      };

      // Modal agregar producto
      var addItemModalOverlay = document.getElementById('addItemModalOverlay');
      var addItemSkuInput = document.getElementById('addItemSku');
      var addItemNameInput = document.getElementById('addItemName');
      var addItemQtyInput = document.getElementById('addItemQty');

      addItemBtn.onclick = function() {
        addItemSkuInput.value = '';
        addItemNameInput.value = '';
        addItemQtyInput.value = '1';
        addItemModalOverlay.classList.add('show');
        addItemSkuInput.focus();
      };

      document.getElementById('addItemCancel').onclick = function() {
        addItemModalOverlay.classList.remove('show');
      };

      document.getElementById('addItemConfirm').onclick = function() {
        var sku = addItemSkuInput.value.trim();
        var name = addItemNameInput.value.trim();
        var qty = parseInt(addItemQtyInput.value) || 1;
        if (qty < 1) qty = 1;
        if (!sku && !name) {
          showStatus('Ingresa al menos un SKU o nombre', 'error');
          return;
        }
        currentItems.push({
          sku: sku,
          name: name || sku,
          quantity: qty,
          inconsistencia: '',
          resolucionInfo: null
        });
        unitMethods[currentItems.length - 1] = [];
        addItemModalOverlay.classList.remove('show');
        // Refresh whichever screen is active
        if (currentScreen === 'order-loaded') {
          renderPreviewItems();
        } else {
          renderPanel();
          refreshCurrentVerificationScreen();
        }
        showStatus('Producto agregado', 'success');
      };

      document.getElementById('startFastBtn').onclick = function() {
        timestampInicio = new Date().toISOString();
        verificationPath = 'scan_only';
        transitionState('verifying_scan_only');
        switchScreen('fast-path');
        renderFastPath();
      };

      document.getElementById('startSeqBtn').onclick = function() {
        timestampInicio = new Date().toISOString();
        verificationPath = 'sequential';
        transitionState('verifying_sequential');
        sequentialIndex = 0;
        switchScreen('sequential');
        renderSequentialItem();
      };

      function resetOrder() {
        currentItems = [];
        unitMethods = {};
        currentOrderId = '';
        currentAccount = '';
        orderState = 'pending_verification';
        verificationPath = null;
        timestampInicio = null;
        codigosDesconocidos = [];
        sequentialIndex = 0;
        productoAVerificar = null;
        orderInput.value = '';
        hideStatus();
        stopCamera();
        switchScreen('order-search');
      }

      resetBtn.onclick = resetOrder;

      document.getElementById('deleteOrderBtn').onclick = function() {
        if (!currentOrderId) return;
        if (!confirm('Eliminar orden #' + currentOrderId + ' y todos sus items del registro?')) return;
        showStatus('Eliminando orden...', 'loading');
        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId, { method: 'DELETE' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) {
              showStatus('Orden eliminada', 'success');
              resetOrder();
            } else {
              showStatus('Error: ' + (data.error || 'No se pudo eliminar'), 'error');
            }
          })
          .catch(function(err) { showStatus('Error: ' + err.message, 'error'); });
      };

      // ============================================
      // FAST PATH
      // ============================================
      function renderFastPath() {
        var verified = getTotalVerifiedUnits();
        var total = getTotalUnits();
        var pct = total > 0 ? Math.round(verified / total * 100) : 0;

        document.getElementById('fastProgressFill').style.width = pct + '%';
        document.getElementById('fastProgressText').textContent = verified + '/' + total;

        var list = document.getElementById('fastItemsList');
        list.innerHTML = '';
        currentItems.forEach(function(item, idx) {
          var v = getVerifiedCount(idx);
          var complete = v >= item.quantity;
          var div = document.createElement('div');
          div.className = 'fast-item' + (complete ? ' complete' : '');

          var statusCls = complete ? 'done' : (v > 0 ? 'partial' : 'pending');
          var statusIcon = complete ? '&#10003;' : (v > 0 ? v : '');

          div.innerHTML = '<div class="fast-item-status ' + statusCls + '">' + statusIcon + '</div>' +
            '<div class="fast-item-info"><div class="fast-item-name">' + (item.name || item.sku) + '</div>' +
            '<div class="fast-item-progress">' + v + '/' + item.quantity + '</div></div>';
          list.appendChild(div);
        });

        // Check if all complete
        if (allItemsComplete()) {
          transitionState('verified_scan_only');
        }
      }

      document.getElementById('fastToSeqBtn').onclick = function() {
        if (verificationPath === 'scan_only') verificationPath = 'mixed';
        orderState = 'verifying_scan_only'; // allow transition
        transitionState('verifying_sequential');
        sequentialIndex = 0;
        // Skip already-complete items
        while (sequentialIndex < currentItems.length && isItemComplete(sequentialIndex)) {
          sequentialIndex++;
        }
        if (sequentialIndex >= currentItems.length) sequentialIndex = 0;
        switchScreen('sequential');
        renderSequentialItem();
      };

      document.getElementById('fastPanelBtn').onclick = function() { openPanel(); };

      // ============================================
      // SCANNER (shared by fast & sequential)
      // ============================================
      function findItemBySkuFlexible(sku) {
        for (var i = 0; i < currentItems.length; i++) {
          if (currentItems[i].sku === sku) return i;
        }
        for (var i = 0; i < currentItems.length; i++) {
          var itemSku = currentItems[i].sku;
          if (itemSku && sku.toUpperCase().indexOf(itemSku.toUpperCase()) !== -1) return i;
        }
        return -1;
      }

      // FIFO: find first item with pending units for a given SKU
      function findFirstPendingForSku(sku) {
        var idx = -1;
        for (var i = 0; i < currentItems.length; i++) {
          var itemSku = (currentItems[i].sku || '').toUpperCase();
          var skuUp = sku.toUpperCase();
          if (itemSku === skuUp || itemSku.indexOf(skuUp) !== -1 || skuUp.indexOf(itemSku) !== -1) {
            if (!isItemComplete(i)) { idx = i; break; }
            if (idx === -1) idx = i; // fallback to first match even if complete
          }
        }
        return idx;
      }

      // ============================================
      // FEEDBACK
      // ============================================
      var scanSuccessBanner = document.getElementById('scanSuccessBanner');
      var scanSuccessText = document.getElementById('scanSuccessText');
      var scanSuccessSku = document.getElementById('scanSuccessSku');
      var scanSuccessCount = document.getElementById('scanSuccessCount');
      var scanErrorBanner = document.getElementById('scanErrorBanner');
      var scanErrorText = document.getElementById('scanErrorText');

      var lastScannedBarcode = null;
      var lastScanTime = 0;
      var SCAN_DEBOUNCE_MS = 2000;

      function showScanSuccess(productName, sku, checkedCount, totalCount) {
        scanSuccessText.textContent = productName || 'Escaneado';
        scanSuccessSku.textContent = sku || '';
        scanSuccessCount.textContent = checkedCount + ' / ' + totalCount;
        scanSuccessBanner.classList.remove('show');
        void scanSuccessBanner.offsetWidth;
        scanSuccessBanner.classList.add('show');
        setTimeout(function() { scanSuccessBanner.classList.remove('show'); }, 500);
      }

      function showScanError(message) {
        scanErrorText.textContent = message || 'Error';
        scanErrorBanner.classList.remove('show');
        void scanErrorBanner.offsetWidth;
        scanErrorBanner.classList.add('show');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
        setTimeout(function() { scanErrorBanner.classList.remove('show'); }, 2000);
      }

      function markProductByBarcode(barcode) {
        var now = Date.now();
        if (barcode === lastScannedBarcode && (now - lastScanTime) < SCAN_DEBOUNCE_MS) return;
        lastScannedBarcode = barcode;
        lastScanTime = now;

        authFetch(API_URL + '/api/barcode/' + encodeURIComponent(barcode))
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.found && data.sku) {
              var itemIndex = findFirstPendingForSku(data.sku);
              if (itemIndex >= 0) {
                var item = currentItems[itemIndex];
                if (isItemComplete(itemIndex)) {
                  showScanError('YA COMPLETO: ' + (item.name || data.sku));
                  return;
                }
                if (!unitMethods[itemIndex]) unitMethods[itemIndex] = [];
                unitMethods[itemIndex].push('scan');
                saveItemVerification(itemIndex, 'scan');

                showScanSuccess(item.name || item.sku, data.sku, getVerifiedCount(itemIndex), item.quantity);
                if (navigator.vibrate) navigator.vibrate(50);

                // Refresh current screen
                if (currentScreen === 'fast-path') {
                  renderFastPath();
                } else if (currentScreen === 'sequential') {
                  renderSequentialItem();
                  // Auto-advance if item complete
                  if (isItemComplete(itemIndex)) {
                    setTimeout(function() {
                      if (sequentialIndex < currentItems.length - 1) {
                        seqNext();
                      } else {
                        checkSequentialCompletion();
                      }
                    }, 800);
                  }
                }
              } else {
                showScanError('NO EN ESTA ORDEN: ' + data.sku);
              }
            } else {
              // Unknown barcode
              if (currentScreen === 'fast-path') {
                // Invalidate fast path
                codigosDesconocidos.push(barcode);
                showScanError('Codigo desconocido - cambiando a secuencial');
                if (verificationPath === 'scan_only') verificationPath = 'mixed';
                orderState = 'verifying_scan_only';
                transitionState('verifying_sequential');
                sequentialIndex = 0;
                while (sequentialIndex < currentItems.length && isItemComplete(sequentialIndex)) sequentialIndex++;
                if (sequentialIndex >= currentItems.length) sequentialIndex = 0;
                switchScreen('sequential');
                renderSequentialItem();
              } else {
                showBarcodeModal(barcode);
              }
            }
          })
          .catch(function(err) {
            console.error('Error buscando barcode:', err);
            showStatus('Error buscando codigo', 'error');
          });
      }

      function showBarcodeModal(barcode) {
        pendingBarcode = barcode;
        modalBarcode.textContent = barcode;
        modalSkuList.innerHTML = '';
        selectedSkuForModal = null;

        currentItems.forEach(function(item) {
          if (!item.sku) return;
          var option = document.createElement('div');
          option.className = 'modal-sku-option';
          option.innerHTML = '<div class="modal-sku-name">' + item.sku + '</div>' +
            '<div class="modal-sku-desc">' + (item.name || '') + '</div>';
          option.onclick = function() {
            document.querySelectorAll('.modal-sku-option').forEach(function(o) { o.classList.remove('selected'); });
            option.classList.add('selected');
            selectedSkuForModal = item.sku;
          };
          modalSkuList.appendChild(option);
        });

        modalOverlay.classList.add('show');
      }

      modalCancel.onclick = function() {
        modalOverlay.classList.remove('show');
        pendingBarcode = null;
        selectedSkuForModal = null;
      };

      modalSave.onclick = function() {
        if (!pendingBarcode || !selectedSkuForModal) {
          showStatus('Selecciona un producto', 'error');
          return;
        }

        var item = currentItems.find(function(i) { return i.sku === selectedSkuForModal; });
        var barcodeToSave = pendingBarcode;
        var skuToSave = selectedSkuForModal;

        authFetch(API_URL + '/api/barcode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode: barcodeToSave, sku: skuToSave, description: item ? item.name : '' })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            showScanSuccess('Codigo guardado: ' + skuToSave, barcodeToSave, '', '');
            markProductByBarcode(barcodeToSave);
          } else {
            showScanError('Error guardando codigo');
          }
          modalOverlay.classList.remove('show');
          pendingBarcode = null;
          selectedSkuForModal = null;
        })
        .catch(function(err) {
          showScanError('Error: ' + err.message);
          modalOverlay.classList.remove('show');
          pendingBarcode = null;
          selectedSkuForModal = null;
        });
      };

      // ============================================
      // SEQUENTIAL PATH
      // ============================================
      function renderSequentialItem() {
        var display = document.getElementById('seqItemContainer');
        var swipeArea = document.getElementById('seqSwipeArea');
        display.innerHTML = '';
        swipeArea.innerHTML = '';

        if (currentItems.length === 0) return;

        // Global progress
        var totalV = getTotalVerifiedUnits();
        var totalU = getTotalUnits();
        var pct = totalU > 0 ? Math.round(totalV / totalU * 100) : 0;
        document.getElementById('seqProgressFill').style.width = pct + '%';
        document.getElementById('seqProgressText').textContent = 'Item ' + (sequentialIndex + 1) + '/' + currentItems.length;

        var item = currentItems[sequentialIndex];
        var verified = getVerifiedCount(sequentialIndex);
        var complete = isItemComplete(sequentialIndex);
        var methods = unitMethods[sequentialIndex] || [];

        // Big product name + SKU
        var nameDiv = document.createElement('div');
        nameDiv.className = 'seq-product-name';
        nameDiv.textContent = item.name || item.sku || 'Sin nombre';
        display.appendChild(nameDiv);

        var skuDiv = document.createElement('div');
        skuDiv.className = 'seq-product-sku';
        skuDiv.textContent = item.sku || 'Sin SKU';
        display.appendChild(skuDiv);

        // Unit indicators
        var unitsDiv = document.createElement('div');
        unitsDiv.className = 'seq-units';
        for (var j = 0; j < item.quantity; j++) {
          var unit = document.createElement('div');
          var m = methods[j] || '';
          unit.className = 'seq-unit' + (m ? ' verified ' + (m === 'scan' ? 'scan' : (m === 'ia' || m === 'claude' ? 'ia' : 'manual')) : '');
          unit.textContent = m ? (m === 'scan' ? 'S' : (m === 'ia' || m === 'claude' ? 'IA' : 'M')) : (j + 1);
          unitsDiv.appendChild(unit);
        }
        display.appendChild(unitsDiv);

        // Status message for complete or inconsistent items
        if (complete) {
          var statusMsg = document.createElement('div');
          statusMsg.className = 'seq-status-msg complete';
          statusMsg.textContent = 'Verificado';
          display.appendChild(statusMsg);
        } else if (item.inconsistencia === 'pendiente') {
          var statusMsg = document.createElement('div');
          statusMsg.className = 'seq-status-msg inconsistent';
          statusMsg.textContent = 'Inconsistencia pendiente';
          display.appendChild(statusMsg);
        }

        // Swipe (only if item has pending units and no inconsistency)
        if (!complete && item.inconsistencia !== 'pendiente') {
          var swipeDiv = document.createElement('div');
          swipeDiv.className = 'swipe-container';
          swipeDiv.id = 'swipeContainer';
          swipeDiv.innerHTML = '<div class="swipe-track"><span class="swipe-track-text">Desliza para confirmar</span></div>' +
            '<div class="swipe-thumb" id="swipeThumb">&#8594;</div>';
          swipeArea.appendChild(swipeDiv);
          setTimeout(function() { initSwipe(sequentialIndex); }, 50);
        }

        // Update toolbar inconsistency button state
        var incBtn = document.getElementById('seqIncBtn');
        if (complete || item.inconsistencia === 'pendiente') {
          incBtn.style.opacity = '0.4';
          incBtn.style.pointerEvents = 'none';
        } else {
          incBtn.style.opacity = '1';
          incBtn.style.pointerEvents = 'auto';
        }
      }

      function initSwipe(itemIndex) {
        var thumb = document.getElementById('swipeThumb');
        var container = document.getElementById('swipeContainer');
        if (!thumb || !container) return;

        var startX = 0;
        var currentX = 0;
        var maxX = 0;

        function onStart(e) {
          startX = e.touches ? e.touches[0].clientX : e.clientX;
          maxX = container.offsetWidth - thumb.offsetWidth - 8;
        }

        function onMove(e) {
          var clientX = e.touches ? e.touches[0].clientX : e.clientX;
          currentX = Math.max(0, Math.min(clientX - startX, maxX));
          thumb.style.left = (4 + currentX) + 'px';

          if (currentX >= maxX * 0.85) {
            thumb.classList.add('confirmed');
          } else {
            thumb.classList.remove('confirmed');
          }
        }

        function onEnd() {
          if (currentX >= maxX * 0.85) {
            // Confirmed
            if (!unitMethods[itemIndex]) unitMethods[itemIndex] = [];
            unitMethods[itemIndex].push('manual');
            saveItemVerification(itemIndex, 'manual');
            if (navigator.vibrate) navigator.vibrate(50);
            renderSequentialItem();
            // Auto-advance if item is now complete
            if (isItemComplete(itemIndex)) {
              setTimeout(function() {
                if (sequentialIndex < currentItems.length - 1) {
                  seqNext();
                } else {
                  checkSequentialCompletion();
                }
              }, 600);
            }
          } else {
            thumb.style.left = '4px';
            thumb.classList.remove('confirmed');
          }
          currentX = 0;
        }

        thumb.addEventListener('touchstart', onStart);
        thumb.addEventListener('touchmove', onMove);
        thumb.addEventListener('touchend', onEnd);
        thumb.addEventListener('mousedown', function(e) {
          onStart(e);
          function mm(ev) { onMove(ev); }
          function mu(ev) { onEnd(); document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); }
          document.addEventListener('mousemove', mm);
          document.addEventListener('mouseup', mu);
        });
      }

      function markInconsistency(itemIndex) {
        var item = currentItems[itemIndex];
        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId + '/item/inconsistencia', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sku: item.sku, accion: 'marcar' })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            currentItems[itemIndex].inconsistencia = 'pendiente';
            showStatus('Inconsistencia marcada', 'success');
            renderSequentialItem();
            // Auto-advance to next item
            if (sequentialIndex < currentItems.length - 1) {
              setTimeout(function() { seqNext(); }, 800);
            }
          }
        })
        .catch(function(err) { showStatus('Error: ' + err.message, 'error'); });
      }

      function seqNext() {
        if (sequentialIndex < currentItems.length - 1) {
          sequentialIndex++;
          renderSequentialItem();
        } else {
          checkSequentialCompletion();
        }
      }

      function checkSequentialCompletion() {
        var hasInconsistenciaPendiente = currentItems.some(function(it) { return it.inconsistencia === 'pendiente'; });

        if (hasInconsistenciaPendiente) {
          if (allItemsComplete()) {
            transitionState('blocked_inconsistency');
          }
          return;
        }

        if (allItemsComplete()) {
          if (orderState === 'verifying_scan_only') {
            transitionState('verified_scan_only');
          } else {
            transitionState('verified_sequential');
          }
        }
      }

      // Sequential toolbar handlers
      document.getElementById('seqScanBtn').onclick = function() {
        startCamera();
        cameraContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };

      document.getElementById('seqIaBtn').onclick = function() {
        productoAVerificar = {
          index: sequentialIndex,
          item: currentItems[sequentialIndex],
          descripcion: currentItems[sequentialIndex].name || currentItems[sequentialIndex].sku,
          fotosMinimas: 1
        };
        startCamera();
        cameraContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };

      document.getElementById('seqFastBtn').onclick = function() {
        if (verificationPath === 'sequential') verificationPath = 'mixed';
        switchScreen('fast-path');
        renderFastPath();
      };

      document.getElementById('seqOrdenBtn').onclick = function() { openPanel(); };

      document.getElementById('seqIncBtn').onclick = function() {
        markInconsistency(sequentialIndex);
      };

      // Sync USB toggle in toolbar with the main toggle
      document.getElementById('seqUsbToggle').onclick = function() {
        toggleUSBMode();
      };

      // ============================================
      // PANEL OVERLAY
      // ============================================
      var panelEditMode = false;
      var panelEditBtn = document.getElementById('panelEditBtn');
      var panelAddBtn = document.getElementById('panelAddBtn');

      function openPanel() {
        panelEditMode = false;
        panelEditBtn.textContent = 'Editar';
        panelEditBtn.classList.remove('active');
        panelAddBtn.classList.remove('show');
        renderPanel();
        panelOverlay.classList.add('show');
      }

      function closePanel() {
        panelOverlay.classList.remove('show');
        panelEditMode = false;
        panelEditBtn.textContent = 'Editar';
        panelEditBtn.classList.remove('active');
        panelAddBtn.classList.remove('show');
      }

      panelBtnOpen.onclick = openPanel;
      panelOverlay.onclick = function(e) {
        if (e.target === panelOverlay) closePanel();
      };

      panelEditBtn.onclick = function() {
        panelEditMode = !panelEditMode;
        panelEditBtn.textContent = panelEditMode ? 'Listo' : 'Editar';
        panelEditBtn.classList.toggle('active', panelEditMode);
        if (panelEditMode) { panelAddBtn.classList.add('show'); } else { panelAddBtn.classList.remove('show'); }
        renderPanel();
      };

      panelAddBtn.onclick = function() {
        document.getElementById('addItemSku').value = '';
        document.getElementById('addItemName').value = '';
        document.getElementById('addItemQty').value = '1';
        document.getElementById('addItemModalOverlay').classList.add('show');
        document.getElementById('addItemSku').focus();
      };

      function renderPanel() {
        var totalV = getTotalVerifiedUnits();
        var totalU = getTotalUnits();
        var pct = totalU > 0 ? Math.round(totalV / totalU * 100) : 0;
        document.getElementById('panelProgressFill').style.width = pct + '%';
        document.getElementById('panelProgressPct').textContent = pct + '%';

        var list = document.getElementById('panelItemsList');
        list.innerHTML = '';

        currentItems.forEach(function(item, idx) {
          var v = getVerifiedCount(idx);
          var complete = isItemComplete(idx);
          var methods = unitMethods[idx] || [];

          var statusClass = 'gray';
          var itemClass = '';
          if (item.inconsistencia === 'pendiente') { statusClass = 'red'; itemClass = 'inconsistent'; }
          else if (complete) { statusClass = 'green'; itemClass = 'done'; }
          else if (v > 0) { statusClass = 'yellow'; itemClass = 'partial'; }

          var div = document.createElement('div');
          div.className = 'panel-item ' + itemClass + (panelEditMode ? ' editing' : '');

          var methodIcons = methods.map(function(m) {
            if (m === 'scan') return 'S';
            if (m === 'ia' || m === 'claude') return 'IA';
            return 'M';
          }).join(' ');

          div.innerHTML = '<div class="panel-item-dot ' + statusClass + '"></div>' +
            '<div class="panel-item-info">' +
            '<div class="panel-item-name">' + (item.name || item.sku) + '</div>' +
            '<div class="panel-item-detail">' + (item.sku || '') + ' - ' + v + '/' + item.quantity + (methodIcons ? ' [' + methodIcons + ']' : '') + '</div></div>';

          if (panelEditMode) {
            // Edit controls: delete, qty -/+
            var actions = document.createElement('div');
            actions.className = 'panel-item-actions';
            actions.style.display = 'flex';

            var delBtn = document.createElement('button');
            delBtn.className = 'panel-item-del';
            delBtn.textContent = '\u00D7';
            delBtn.setAttribute('data-idx', idx);
            delBtn.onclick = function(e) {
              e.stopPropagation();
              var i = parseInt(this.getAttribute('data-idx'));
              var it = currentItems[i];
              if (!confirm('Eliminar "' + (it.name || it.sku) + '"?')) return;
              currentItems.splice(i, 1);
              var newMethods = {};
              for (var k = 0; k < currentItems.length; k++) {
                newMethods[k] = k < i ? (unitMethods[k] || []) : (unitMethods[k + 1] || []);
              }
              unitMethods = newMethods;
              if (sequentialIndex >= currentItems.length) sequentialIndex = Math.max(0, currentItems.length - 1);
              renderPanel();
              refreshCurrentVerificationScreen();
            };
            actions.appendChild(delBtn);

            var minusBtn = document.createElement('button');
            minusBtn.className = 'panel-qty-btn';
            minusBtn.textContent = '\u2212';
            minusBtn.setAttribute('data-idx', idx);
            minusBtn.onclick = function(e) {
              e.stopPropagation();
              var i = parseInt(this.getAttribute('data-idx'));
              if (currentItems[i].quantity > 1) {
                currentItems[i].quantity--;
                var m = unitMethods[i] || [];
                if (m.length > currentItems[i].quantity) unitMethods[i] = m.slice(0, currentItems[i].quantity);
                renderPanel();
                refreshCurrentVerificationScreen();
              }
            };
            actions.appendChild(minusBtn);

            var qtyVal = document.createElement('span');
            qtyVal.className = 'panel-qty-val';
            qtyVal.textContent = item.quantity;
            actions.appendChild(qtyVal);

            var plusBtn = document.createElement('button');
            plusBtn.className = 'panel-qty-btn';
            plusBtn.textContent = '+';
            plusBtn.setAttribute('data-idx', idx);
            plusBtn.onclick = function(e) {
              e.stopPropagation();
              var i = parseInt(this.getAttribute('data-idx'));
              currentItems[i].quantity++;
              renderPanel();
              refreshCurrentVerificationScreen();
            };
            actions.appendChild(plusBtn);

            div.appendChild(actions);
          } else {
            // Resolve button for inconsistencies
            if (item.inconsistencia === 'pendiente') {
              var resolveBtn = document.createElement('button');
              resolveBtn.className = 'panel-resolve-btn';
              resolveBtn.textContent = 'Resolver';
              resolveBtn.setAttribute('data-idx', idx);
              resolveBtn.onclick = function(e) {
                e.stopPropagation();
                openResolveModal(parseInt(this.getAttribute('data-idx')));
              };
              div.appendChild(resolveBtn);
            }
          }

          // Click to navigate to item in sequential (only when not editing)
          if (!panelEditMode) {
            div.setAttribute('data-idx', idx);
            div.onclick = function() {
              var i = parseInt(this.getAttribute('data-idx'));
              closePanel();
              if (currentScreen === 'sequential') {
                sequentialIndex = i;
                renderSequentialItem();
              }
            };
          }

          list.appendChild(div);
        });
      }

      // Helper to refresh the active verification screen after editing items
      function refreshCurrentVerificationScreen() {
        if (currentScreen === 'sequential') {
          renderSequentialItem();
        } else if (currentScreen === 'fast-path') {
          renderFastPath();
        }
      }

      // ============================================
      // RESOLVE MODAL
      // ============================================
      var resolveModal = document.getElementById('resolveModal');
      var resolveNota = document.getElementById('resolveNota');
      var resolveCharCount = document.getElementById('resolveCharCount');
      var resolveConfirmBtn = document.getElementById('resolveConfirmBtn');
      var resolveItemInfo = document.getElementById('resolveItemInfo');
      var resolveAction = 'resolver';
      var resolveItemIdx = -1;

      function openResolveModal(itemIdx) {
        resolveItemIdx = itemIdx;
        var item = currentItems[itemIdx];
        resolveItemInfo.textContent = (item.sku || '') + ' - ' + (item.name || '');
        resolveNota.value = '';
        resolveCharCount.textContent = '0/10';
        resolveConfirmBtn.disabled = true;
        resolveAction = 'resolver';
        document.getElementById('resolveOptResolve').classList.add('selected');
        document.getElementById('resolveOptFaltante').classList.remove('selected');
        resolveModal.classList.add('show');
      }

      document.getElementById('resolveOptResolve').onclick = function() {
        resolveAction = 'resolver';
        this.classList.add('selected');
        document.getElementById('resolveOptFaltante').classList.remove('selected');
      };

      document.getElementById('resolveOptFaltante').onclick = function() {
        resolveAction = 'confirmar_faltante';
        this.classList.add('selected');
        document.getElementById('resolveOptResolve').classList.remove('selected');
      };

      resolveNota.oninput = function() {
        var len = resolveNota.value.length;
        resolveCharCount.textContent = len + '/10';
        resolveConfirmBtn.disabled = (len < 10);
      };

      document.getElementById('resolveCancelBtn').onclick = function() {
        resolveModal.classList.remove('show');
      };

      resolveConfirmBtn.onclick = function() {
        if (resolveItemIdx < 0) return;
        var item = currentItems[resolveItemIdx];

        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId + '/item/inconsistencia', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sku: item.sku,
            accion: resolveAction,
            nota: resolveNota.value,
            quien: 'user'
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            currentItems[resolveItemIdx].inconsistencia = data.inconsistencia;
            resolveModal.classList.remove('show');
            showStatus('Inconsistencia ' + (resolveAction === 'resolver' ? 'resuelta' : 'confirmada como faltante'), 'success');
            renderPanel();

            // Check if all inconsistencies resolved
            var pendientes = currentItems.filter(function(it) { return it.inconsistencia === 'pendiente'; });
            if (pendientes.length === 0 && allItemsComplete()) {
              closePanel();
              transitionState('verified_sequential');
            }
          }
        })
        .catch(function(err) { showStatus('Error: ' + err.message, 'error'); });
      };

      // ============================================
      // COMPLETE SCREEN
      // ============================================
      function showCompleteScreen() {
        switchScreen('complete');

        var scanCount = 0, iaCount = 0, manualCount = 0;
        for (var i = 0; i < currentItems.length; i++) {
          var methods = unitMethods[i] || [];
          methods.forEach(function(m) {
            if (m === 'scan') scanCount++;
            else if (m === 'ia' || m === 'claude') iaCount++;
            else manualCount++;
          });
        }

        var elapsed = '';
        if (timestampInicio) {
          var diff = Math.round((Date.now() - new Date(timestampInicio).getTime()) / 1000);
          var mins = Math.floor(diff / 60);
          var secs = diff % 60;
          elapsed = mins + 'm ' + secs + 's';
        }

        document.getElementById('completeSubtitle').textContent =
          verificationPath === 'scan_only' ? 'Verificado por escaneo rapido' :
          verificationPath === 'mixed' ? 'Verificado con metodo mixto' : 'Verificado secuencialmente';

        var stats = document.getElementById('completeStats');
        stats.innerHTML = '';
        if (scanCount > 0) stats.innerHTML += '<div class="complete-stat"><div class="complete-stat-val">' + scanCount + '</div><div class="complete-stat-label">SCAN</div></div>';
        if (iaCount > 0) stats.innerHTML += '<div class="complete-stat"><div class="complete-stat-val">' + iaCount + '</div><div class="complete-stat-label">IA</div></div>';
        if (manualCount > 0) stats.innerHTML += '<div class="complete-stat"><div class="complete-stat-val">' + manualCount + '</div><div class="complete-stat-label">MANUAL</div></div>';
        if (elapsed) stats.innerHTML += '<div class="complete-stat"><div class="complete-stat-val">' + elapsed + '</div><div class="complete-stat-label">TIEMPO</div></div>';

        // Faltantes
        var faltantes = currentItems.filter(function(it) { return it.inconsistencia === 'faltante_confirmado'; });
        var faltantesDiv = document.getElementById('completeFaltantes');
        var faltantesList = document.getElementById('completeFaltantesList');
        if (faltantes.length > 0) {
          faltantesDiv.classList.remove('hidden');
          faltantesList.innerHTML = '';
          faltantes.forEach(function(it) {
            var d = document.createElement('div');
            d.className = 'complete-faltante-item';
            d.textContent = (it.sku || '') + ' - ' + (it.name || '');
            faltantesList.appendChild(d);
          });
        } else {
          faltantesDiv.classList.add('hidden');
        }
      }

      document.getElementById('completeCloseBtn').onclick = function() {
        var scanCount = 0, iaCount = 0, manualCount = 0;
        for (var i = 0; i < currentItems.length; i++) {
          (unitMethods[i] || []).forEach(function(m) {
            if (m === 'scan') scanCount++;
            else if (m === 'ia' || m === 'claude') iaCount++;
            else manualCount++;
          });
        }

        var faltantes = currentItems.filter(function(it) { return it.inconsistencia === 'faltante_confirmado'; });
        var estadoFinal = faltantes.length > 0 ? 'parcial' : orderState;

        authFetch(API_URL + '/api/mayorista/order/' + currentOrderId + '/verificado', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            metodo: verificationPath || 'manual',
            estado: estadoFinal,
            camino: verificationPath || 'manual',
            timestampInicio: timestampInicio || '',
            timestampCierre: new Date().toISOString(),
            codigosDesconocidos: codigosDesconocidos,
            totalUnidades: getTotalUnits(),
            resumen: { scan: scanCount, ia: iaCount, manual: manualCount }
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            showStatus('Pedido cerrado correctamente', 'success');
            cargarResumenDia();
          }
        })
        .catch(function(err) { showStatus('Error: ' + err.message, 'error'); });

        // Reset and go to panel
        resetBtn.onclick();
        switchView('panel');
      };

      // ============================================
      // CAMERA
      // ============================================
      function startCamera() {
        if (isScanning) return;
        cameraContainer.classList.add('active');
        isScanning = true;

        if (!codeReader) {
          codeReader = new ZXing.BrowserMultiFormatReader();
        }

        codeReader.decodeFromVideoDevice(null, 'video', function(result, err) {
          if (result) {
            var codigo = result.getText();
            if (navigator.vibrate) navigator.vibrate(50);
            if (currentScreen === 'order-search' && !currentOrderId) {
              orderInput.value = codigo;
              searchOrder(codigo);
              stopCamera();
            } else {
              markProductByBarcode(codigo);
            }
          }
        });
      }

      function stopCamera() {
        if (codeReader) codeReader.reset();
        cameraContainer.classList.remove('active');
        isScanning = false;
        unfreezeCamera();
      }

      // ============================================
      // FREEZE & MULTI-FOTO
      // ============================================
      var capturedImages = [];
      var capturedOverlay = document.getElementById('capturedOverlay');
      var multiPhotoBar = document.getElementById('multiPhotoBar');
      var photoThumbnails = document.getElementById('photoThumbnails');
      var btnOtraFoto = document.getElementById('btnOtraFoto');
      var btnEnviarAnalisis = document.getElementById('btnEnviarAnalisis');

      function freezeCamera(canvas) {
        capturedOverlay.width = canvas.width;
        capturedOverlay.height = canvas.height;
        capturedOverlay.getContext('2d').drawImage(canvas, 0, 0);
        cameraContainer.classList.add('frozen');
      }

      function unfreezeCamera() {
        cameraContainer.classList.remove('frozen');
        multiPhotoBar.classList.remove('active');
        capturedImages = [];
        photoThumbnails.innerHTML = '';
      }

      function showMultiPhotoBar() {
        capturePhotoBtn.style.display = 'none';
        multiPhotoBar.classList.add('active');
        var minFotos = (productoAVerificar && productoAVerificar.fotosMinimas) || 1;
        var faltan = minFotos - capturedImages.length;
        if (faltan > 0) {
          btnEnviarAnalisis.disabled = true;
          btnEnviarAnalisis.textContent = 'Falta' + (faltan > 1 ? 'n ' : ' ') + faltan + ' foto' + (faltan > 1 ? 's' : '');
        } else {
          btnEnviarAnalisis.disabled = false;
          btnEnviarAnalisis.textContent = 'Enviar analisis';
        }
      }

      function hideMultiPhotoBar() {
        multiPhotoBar.classList.remove('active');
        capturePhotoBtn.style.display = '';
        btnEnviarAnalisis.disabled = false;
        btnEnviarAnalisis.textContent = 'Enviar analisis';
      }

      btnOtraFoto.onclick = function() {
        cameraContainer.classList.remove('frozen');
        hideMultiPhotoBar();
        capturePhotoBtn.disabled = false;
        capturePhotoBtn.textContent = 'Tomar otra foto';
      };

      btnEnviarAnalisis.onclick = function() { sendImagesToAnalyze(capturedImages); };

      function sendImagesToAnalyze(images) {
        hideMultiPhotoBar();
        capturePhotoBtn.disabled = true;
        capturePhotoBtn.style.display = '';
        capturePhotoBtn.textContent = 'Analizando...';
        showStatus('Claude esta analizando ' + images.length + ' foto(s)...', 'loading');

        var requestBody = { images: images };
        if (productoAVerificar) {
          requestBody.producto = {
            descripcion: productoAVerificar.descripcion,
            sku: productoAVerificar.item ? productoAVerificar.item.sku : ''
          };
        }

        authFetch(API_URL + '/api/vision/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          capturePhotoBtn.disabled = false;
          capturePhotoBtn.textContent = 'Analizar con IA';
          unfreezeCamera();

          if (data.success) {
            if (productoAVerificar && data.correcto !== undefined) {
              stopCamera();
              if (data.correcto) {
                showStatus('CORRECTO: ' + data.productoDetectado, 'success');
                var idx = productoAVerificar.index;
                if (!unitMethods[idx]) unitMethods[idx] = [];
                unitMethods[idx].push('ia');
                saveItemVerification(idx, 'ia');
                if (currentScreen === 'sequential') {
                  renderSequentialItem();
                  if (isItemComplete(idx)) {
                    setTimeout(function() {
                      if (sequentialIndex < currentItems.length - 1) {
                        seqNext();
                      } else {
                        checkSequentialCompletion();
                      }
                    }, 800);
                  }
                } else if (currentScreen === 'fast-path') {
                  renderFastPath();
                }
              } else {
                showStatus('INCORRECTO: ' + (data.motivo || 'No coincide'), 'error');
              }
              productoAVerificar = null;
            } else {
              showStatus('Analisis completado', 'success');
            }
          } else {
            showStatus('Error: ' + (data.error || 'Error desconocido'), 'error');
          }
        })
        .catch(function(err) {
          capturePhotoBtn.disabled = false;
          capturePhotoBtn.textContent = 'Analizar con IA';
          unfreezeCamera();
          showStatus('Error de conexion', 'error');
        });
      }

      capturePhotoBtn.onclick = function() {
        if (!video.srcObject) { showStatus('Camara no activa', 'error'); return; }
        var canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        var imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
        freezeCamera(canvas);
        capturedImages.push(imageBase64);
        var img = document.createElement('img');
        img.src = imageBase64;
        img.className = 'photo-thumb';
        photoThumbnails.appendChild(img);

        var maxFotos = productoAVerificar && productoAVerificar.fotosMaximas;
        if (maxFotos && capturedImages.length >= maxFotos) {
          sendImagesToAnalyze(capturedImages);
          return;
        }
        showMultiPhotoBar();
        showStatus('Foto ' + capturedImages.length + ' capturada', 'success');
      };

      cameraBtn.onclick = function() {
        if (isScanning) { stopCamera(); } else { startCamera(); }
      };
      closeCameraBtn.onclick = function() { stopCamera(); };

      // ============================================
      // USB SCANNER
      // ============================================
      var usbToggle = document.getElementById('usbToggle');
      var usbScannerInput = document.getElementById('usbScannerInput');
      var usbModeActive = false;

      function toggleUSBMode() {
        usbModeActive = !usbModeActive;
        usbToggle.classList.toggle('active', usbModeActive);
        document.getElementById('seqUsbToggle').classList.toggle('active', usbModeActive);
        if (usbModeActive) {
          usbScannerInput.classList.remove('hidden');
          usbScannerInput.focus();
          stopCamera();
        } else {
          usbScannerInput.classList.add('hidden');
          usbScannerInput.value = '';
        }
      }

      usbToggle.onclick = toggleUSBMode;

      usbScannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          var codigo = usbScannerInput.value.trim();
          if (!codigo) return;
          usbScannerInput.value = '';

          if (currentScreen === 'order-search' && !currentOrderId) {
            orderInput.value = codigo;
            searchOrder(codigo);
          } else {
            markProductByBarcode(codigo);
          }
          setTimeout(function() { usbScannerInput.focus(); }, 100);
        }
      });

      usbScannerInput.addEventListener('blur', function() {
        if (usbModeActive) {
          setTimeout(function() {
            if (usbModeActive && !document.querySelector('.modal-overlay.show') && !document.querySelector('.resolve-modal.show')) {
              usbScannerInput.focus();
            }
          }, 200);
        }
      });

      // ============================================
      // INIT
      // ============================================
      switchView('panel');
      switchScreen('order-search');
    }
  </script>
</body>
</html>
