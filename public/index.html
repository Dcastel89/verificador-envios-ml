<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <title>Verificador de Envios</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; }
    .header { background: #2563eb; color: white; padding: 16px; text-align: center; }
    .header h1 { font-size: 18px; font-weight: 600; }
    .account-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-top: 8px; }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .scan-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .scan-input-group { display: flex; gap: 8px; }
    .scan-input { flex: 1; padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; }
    .scan-btn { padding: 14px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .scan-btn:disabled { background: #9ca3af; }
    .camera-btn { width: 100%; padding: 14px; margin-top: 12px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .camera-container { display: none; margin-top: 16px; position: relative; }
    .camera-container.active { display: block; }
    #video { width: 100%; border-radius: 8px; }
    .close-camera { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .status-message.show { display: block; }
    .status-message.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-message.loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .items-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .items-header { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .items-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .items-count { font-size: 14px; color: #6b7280; }
    .item-card { padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: flex-start; gap: 12px; }
    .item-card:last-child { border-bottom: none; }
    .item-card.checked { background: #f0fdf4; }
    .item-main-checkbox { width: 28px; height: 28px; cursor: pointer; flex-shrink: 0; margin-top: 4px; pointer-events: none; }
    .item-info { flex: 1; }
    .item-description { font-size: 20px; font-weight: 700; color: #111827; line-height: 1.3; }
    .item-sku { font-size: 14px; color: #6b7280; margin-top: 6px; font-family: monospace; }
    .item-quantity { font-size: 18px; color: #111827; font-weight: 700; margin-top: 8px; background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; }
    .item-kit-badge { display: inline-block; background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; vertical-align: middle; }
    .unit-checkboxes { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
    .unit-checkbox { width: 36px; height: 36px; cursor: pointer; accent-color: #22c55e; }
    .complete-banner { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #22c55e; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: 600; z-index: 100; }
    .complete-banner.show { display: block; }
    .reset-btn { width: 100%; padding: 14px; margin-top: 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Verificador de Envios</h1>
    <div class="account-badge" id="accountBadge">Sin conexion</div>
  </div>
  <div class="container">
    <div class="scan-section">
      <div class="scan-input-group">
        <input type="text" id="shipmentInput" class="scan-input" placeholder="Numero de envio...">
        <button type="button" id="searchBtn" class="scan-btn">Buscar</button>
      </div>
      <button type="button" id="cameraBtn" class="camera-btn">Escanear con camara</button>
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <button type="button" class="close-camera" id="closeCamera">✕</button>
      </div>
    </div>
    <div class="status-message" id="statusMessage"></div>
    <div class="items-section hidden" id="itemsSection">
      <div class="items-header">
        <h2>Productos a verificar</h2>
        <span class="items-count" id="itemsCount">0/0</span>
      </div>
      <div id="itemsList"></div>
    </div>
    <button type="button" class="reset-btn hidden" id="resetBtn">Nuevo envio</button>
  </div>
  <div class="complete-banner" id="completeBanner">✓ Envio verificado correctamente</div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    (function() {
      var API_URL = '';
      var currentItems = [];
      var unitChecks = {};
      var codeReader = null;
      var isScanning = false;
      var currentShipmentId = '';
      var currentAccount = '';
      var alreadySaved = false;

      var shipmentInput = document.getElementById('shipmentInput');
      var searchBtn = document.getElementById('searchBtn');
      var cameraBtn = document.getElementById('cameraBtn');
      var cameraContainer = document.getElementById('cameraContainer');
      var closeCameraBtn = document.getElementById('closeCamera');
      var video = document.getElementById('video');
      var statusMessage = document.getElementById('statusMessage');
      var itemsSection = document.getElementById('itemsSection');
      var itemsList = document.getElementById('itemsList');
      var itemsCount = document.getElementById('itemsCount');
      var completeBanner = document.getElementById('completeBanner');
      var resetBtn = document.getElementById('resetBtn');
      var accountBadge = document.getElementById('accountBadge');

      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message show ' + type;
      }

      function hideStatus() {
        statusMessage.className = 'status-message';
      }

      function isItemComplete(index) {
        var item = currentItems[index];
        var checks = unitChecks[index] || [];
        for (var i = 0; i < item.quantity; i++) {
          if (!checks[i]) return false;
        }
        return true;
      }

      function countCompletedItems() {
        var count = 0;
        for (var i = 0; i < currentItems.length; i++) {
          if (isItemComplete(i)) count++;
        }
        return count;
      }

      function saveVerification() {
        if (alreadySaved) return;
        alreadySaved = true;
        
        fetch(API_URL + '/api/shipment/' + currentShipmentId + '/verificado', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: currentItems, cuenta: currentAccount })
        }).catch(function(err) {
          console.error('Error guardando verificacion:', err);
        });
      }

      function updateItemsCount() {
        var total = currentItems.length;
        var checked = countCompletedItems();
        itemsCount.textContent = checked + '/' + total;
        if (checked === total && total > 0) {
          completeBanner.classList.add('show');
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          saveVerification();
        } else {
          completeBanner.classList.remove('show');
        }
      }

      function updateCard(index) {
        var card = document.querySelector('.item-card[data-index="' + index + '"]');
        if (!card) return;
        var mainCheckbox = card.querySelector('.item-main-checkbox');
        var complete = isItemComplete(index);
        mainCheckbox.checked = complete;
        card.className = 'item-card' + (complete ? ' checked' : '');
        updateItemsCount();
      }

      function renderItems() {
        itemsList.innerHTML = '';
        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          unitChecks[i] = [];
          
          var card = document.createElement('div');
          card.className = 'item-card';
          card.setAttribute('data-index', i);
          
          var mainCheckbox = document.createElement('input');
          mainCheckbox.type = 'checkbox';
          mainCheckbox.className = 'item-main-checkbox';
          mainCheckbox.checked = false;
          
          var info = document.createElement('div');
          info.className = 'item-info';
          
          var descDiv = document.createElement('div');
          descDiv.className = 'item-description';
          descDiv.textContent = item.description || item.title || item.sku;
          if (item.isKit) {
            var badge = document.createElement('span');
            badge.className = 'item-kit-badge';
            badge.textContent = 'KIT';
            descDiv.appendChild(badge);
          }
          
          var skuDiv = document.createElement('div');
          skuDiv.className = 'item-sku';
          skuDiv.textContent = 'SKU: ' + item.sku;
          
          var qtyDiv = document.createElement('div');
          qtyDiv.className = 'item-quantity';
          qtyDiv.textContent = 'Cantidad: ' + item.quantity;
          
          var unitsDiv = document.createElement('div');
          unitsDiv.className = 'unit-checkboxes';
          
          for (var j = 0; j < item.quantity; j++) {
            var unitCb = document.createElement('input');
            unitCb.type = 'checkbox';
            unitCb.className = 'unit-checkbox';
            unitCb.setAttribute('data-item', i);
            unitCb.setAttribute('data-unit', j);
            unitsDiv.appendChild(unitCb);
          }
          
          info.appendChild(descDiv);
          info.appendChild(skuDiv);
          info.appendChild(qtyDiv);
          info.appendChild(unitsDiv);
          card.appendChild(mainCheckbox);
          card.appendChild(info);
          itemsList.appendChild(card);
        }
        updateItemsCount();
      }

      itemsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('unit-checkbox')) {
          var itemIndex = parseInt(e.target.getAttribute('data-item'));
          var unitIndex = parseInt(e.target.getAttribute('data-unit'));
          if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];
          unitChecks[itemIndex][unitIndex] = e.target.checked;
          updateCard(itemIndex);
        }
      });

      function searchShipment(shipmentId) {
        if (!shipmentId || shipmentId.trim() === '') {
          showStatus('Ingresa un numero de envio', 'error');
          return;
        }
        showStatus('Buscando envio...', 'loading');
        searchBtn.disabled = true;
        searchBtn.textContent = '...';
        fetch(API_URL + '/api/shipment/' + shipmentId.trim())
          .then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) throw new Error(data.error || 'Error al buscar envio');
              return data;
            });
          })
          .then(function(data) {
            currentItems = data.items;
            unitChecks = {};
            currentShipmentId = shipmentId.trim();
            currentAccount = data.account;
            alreadySaved = false;
            accountBadge.textContent = data.account;
            hideStatus();
            itemsSection.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            renderItems();
            stopCamera();
          })
          .catch(function(error) {
            showStatus(error.message, 'error');
            itemsSection.classList.add('hidden');
          })
          .finally(function() {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Buscar';
          });
      }

      function extractShipmentId(texto) {
        if (texto.indexOf('"id"') > -1) {
          var match = texto.match(/"id"\s*:\s*"(\d+)"/);
          if (match) return match[1];
        }
        if (texto.indexOf('shipment_id=') > -1) {
          var match = texto.match(/shipment_id=(\d+)/);
          if (match) return match[1];
        }
        if (texto.indexOf('/shipments/') > -1) {
          var match = texto.match(/\/shipments\/(\d+)/);
          if (match) return match[1];
        }
        return texto;
      }

      function startCamera() {
        if (typeof ZXing === 'undefined') {
          showStatus('Error: libreria de camara no cargada', 'error');
          return;
        }
        if (!codeReader) {
          var hints = new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.QR_CODE,
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.CODE_39,
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.EAN_8
          ]);
          codeReader = new ZXing.BrowserMultiFormatReader(hints);
        }
        cameraContainer.classList.add('active');
        isScanning = true;
        codeReader.decodeFromVideoDevice(null, 'video', function(result, error) {
          if (result && isScanning) {
            isScanning = false;
            var texto = extractShipmentId(result.getText());
            shipmentInput.value = texto;
            stopCamera();
            searchShipment(texto);
          }
        }).catch(function(err) {
          showStatus('No se pudo acceder a la camara', 'error');
          stopCamera();
        });
      }

      function stopCamera() {
        isScanning = false;
        cameraContainer.classList.remove('active');
        if (codeReader) codeReader.reset();
      }

      function reset() {
        currentItems = [];
        unitChecks = {};
        currentShipmentId = '';
        currentAccount = '';
        alreadySaved = false;
        shipmentInput.value = '';
        itemsSection.classList.add('hidden');
        resetBtn.classList.add('hidden');
        completeBanner.classList.remove('show');
        hideStatus();
        accountBadge.textContent = 'Sin conexion';
        shipmentInput.focus();
      }

      searchBtn.onclick = function() { searchShipment(shipmentInput.value); };
      shipmentInput.onkeypress = function(e) { if (e.key === 'Enter') searchShipment(shipmentInput.value); };
      cameraBtn.onclick = startCamera;
      closeCameraBtn.onclick = stopCamera;
      resetBtn.onclick = reset;

      console.log('App iniciada v6');
    })();
  </script>
</body>
</html>
