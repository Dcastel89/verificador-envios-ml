<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <title>Verificador de Envios</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; padding-bottom: 80px; }
    .header { background: #2563eb; color: white; padding: 16px; text-align: center; }
    .header h1 { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .nav-tabs { display: flex; gap: 8px; justify-content: center; }
    .nav-tab { padding: 8px 24px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: white; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .nav-tab:hover { background: rgba(255,255,255,0.1); }
    .nav-tab.active { background: white; color: #2563eb; border-color: white; }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .account-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-top: 8px; }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .scan-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .scan-input-group { display: flex; gap: 8px; }
    .scan-input { flex: 1; padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; }
    .scan-btn { padding: 14px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .scan-btn:disabled { background: #9ca3af; }
    .camera-btn { position: fixed; bottom: 0; left: 0; right: 0; padding: 18px; background: #059669; color: white; border: none; font-size: 18px; font-weight: 600; cursor: pointer; z-index: 90; }
    .camera-btn.product-mode { background: #7c3aed; }
    .camera-container { display: none; margin-top: 16px; position: relative; }
    .camera-container.active { display: block; }
    #video { width: 100%; border-radius: 8px; }
    .close-camera { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .capture-photo-btn { position: fixed; bottom: 0; left: 0; right: 0; background: #f59e0b; color: white; border: none; padding: 18px; font-size: 18px; font-weight: 600; cursor: pointer; z-index: 100; }
    .capture-photo-btn:disabled { background: #9ca3af; }
    /* Freeze overlay */
    #capturedOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: none; object-fit: cover; }
    .camera-container.frozen #capturedOverlay { display: block; }
    .camera-container.frozen .capture-photo-btn { display: none; }
    /* Multi-foto UI */
    .multi-photo-bar { position: fixed; bottom: 0; left: 0; right: 0; display: none; z-index: 100; }
    .multi-photo-bar.active { display: flex; }
    .multi-photo-bar button { flex: 1; padding: 18px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; color: white; }
    .multi-photo-bar .btn-otra-foto { background: #3b82f6; }
    .multi-photo-bar .btn-enviar-analisis { background: #059669; }
    .multi-photo-bar .btn-enviar-analisis:disabled { background: #9ca3af; cursor: not-allowed; }
    .photo-thumbnails { display: flex; gap: 6px; padding: 8px; background: rgba(0,0,0,0.5); position: absolute; bottom: 8px; left: 8px; right: 8px; border-radius: 8px; overflow-x: auto; }
    .photo-thumbnails:empty { display: none; }
    .photo-thumb { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 2px solid white; flex-shrink: 0; }
    .vision-result { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 12px; }
    .vision-result-text { font-family: monospace; font-size: 14px; white-space: pre-wrap; word-break: break-all; }
    .vision-result-colors { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .vision-color-chip { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .status-message.show { display: block; }
    .status-message.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-message.loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .status-message.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .items-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .items-header { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .items-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .items-count { font-size: 14px; color: #6b7280; }
    .item-card { padding: 16px; padding-right: 80px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: flex-start; gap: 12px; transition: all 0.3s ease; position: relative; }
    .item-card:last-child { border-bottom: none; }
    .item-card.checked { background: #f0fdf4; }
    .item-card.highlight { background: #fef3c7; animation: pulse 0.5s ease-in-out; }
    .item-card.just-scanned { background: #dcfce7; border-left: 4px solid #22c55e; }
    .item-card.verification-only { background: #fef3c7; border-left: 4px solid #f59e0b; }
    .item-card.verification-only.checked { background: #fef9c3; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .item-main-checkbox { width: 28px; height: 28px; cursor: pointer; flex-shrink: 0; margin-top: 4px; pointer-events: none; }
    .item-info { flex: 1; }
    .item-description { font-size: 20px; font-weight: 700; color: #111827; line-height: 1.3; }
    .item-sku { font-size: 14px; color: #6b7280; margin-top: 6px; font-family: monospace; }
    .item-quantity { font-size: 18px; color: #111827; font-weight: 700; margin-top: 8px; background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; }
    .item-kit-badge { display: inline-block; background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; vertical-align: middle; }
    .unit-checkboxes { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
    .unit-checkbox { width: 36px; height: 36px; cursor: pointer; accent-color: #22c55e; }
    .unit-checkbox.scanned { outline: 3px solid #7c3aed; outline-offset: 2px; }
    .complete-banner { display: none; position: fixed; bottom: 56px; left: 0; right: 0; background: #22c55e; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: 600; z-index: 100; }
    .complete-banner.show { display: block; }
    .complete-banner.partial { background: #f59e0b; }
    .reset-btn { width: 100%; padding: 14px; margin-top: 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .hidden { display: none; }

    /* Modal para guardar barcode */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; }
    .modal h3 { font-size: 18px; margin-bottom: 16px; color: #111827; }
    .modal p { font-size: 14px; color: #6b7280; margin-bottom: 16px; }
    .modal-barcode { font-family: monospace; background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 16px; font-weight: 600; }
    .modal-sku-list { max-height: 200px; overflow-y: auto; margin-bottom: 16px; }
    .modal-sku-option { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
    .modal-sku-option:hover { border-color: #2563eb; background: #eff6ff; }
    .modal-sku-option.selected { border-color: #2563eb; background: #eff6ff; }
    .modal-sku-name { font-weight: 600; color: #111827; }
    .modal-sku-desc { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
    .modal-btn.primary { background: #2563eb; color: white; }
    .modal-btn.secondary { background: #f3f4f6; color: #374151; }

    /* Scan mode indicator */
    .scan-mode-indicator { display: none; background: #7c3aed; color: white; padding: 8px 16px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 14px; font-weight: 600; }
    .scan-mode-indicator.show { display: block; }

    /* Verify photo button - grande y f谩cil de tocar */
    .verify-photo-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #7c3aed; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(124,58,237,0.4); transition: all 0.2s; }
    .verify-photo-btn:hover { background: #6d28d9; transform: translateY(-50%) scale(1.1); }
    .verify-photo-btn:active { background: #5b21b6; transform: translateY(-50%) scale(0.95); }

    /* Bot贸n reportar error SKU - muy discreto */
    .report-error-btn { position: absolute; bottom: 8px; right: 8px; background: transparent; border: none; font-size: 14px; cursor: pointer; opacity: 0.3; padding: 4px 6px; border-radius: 4px; transition: all 0.2s; }
    .report-error-btn:hover, .report-error-btn:focus { opacity: 1; background: #fef2f2; }
    .report-error-btn:active { transform: scale(0.95); }

    /* Modal error SKU */
    .error-modal { background: white; border-radius: 12px; padding: 20px; max-width: 350px; width: 100%; }
    .error-modal h3 { font-size: 16px; margin-bottom: 12px; color: #dc2626; }
    .error-modal-sku { font-family: monospace; background: #fef2f2; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 14px; color: #991b1b; }
    .error-modal-note { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; resize: none; margin-bottom: 12px; }
    .error-modal-note:focus { outline: none; border-color: #dc2626; }

    /* Resumen del d铆a */
    .resumen-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .resumen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .resumen-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .resumen-fecha { font-size: 12px; color: #6b7280; }
    .resumen-stats { display: flex; gap: 12px; margin-bottom: 16px; }
    .resumen-stat { flex: 1; text-align: center; padding: 12px; border-radius: 8px; }
    .resumen-stat.total { background: #eff6ff; }
    .resumen-stat.verificados { background: #f0fdf4; }
    .resumen-stat.pendientes { background: #fef2f2; }
    .resumen-stat-number { font-size: 24px; font-weight: 700; }
    .resumen-stat.total .resumen-stat-number { color: #2563eb; }
    .resumen-stat.verificados .resumen-stat-number { color: #16a34a; }
    .resumen-stat.pendientes .resumen-stat-number { color: #dc2626; }
    .resumen-stat-label { font-size: 11px; color: #6b7280; margin-top: 4px; }
    /* Botones de cuentas */
    .cuentas-btns { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .cuenta-btn { flex: 1; min-width: 60px; padding: 10px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
    .cuenta-btn:hover { border-color: #2563eb; background: #eff6ff; }
    .cuenta-btn.active { border-color: #2563eb; background: #2563eb; color: white; }
    .cuenta-desglose { background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 12px; display: none; }
    .cuenta-desglose.show { display: block; }
    .cuenta-desglose-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .cuenta-desglose-items { display: flex; gap: 16px; justify-content: center; }
    .cuenta-desglose-item { text-align: center; }
    .cuenta-desglose-num { font-size: 20px; font-weight: 700; }
    .cuenta-desglose-num.flex { color: #7c3aed; }
    .cuenta-desglose-num.colecta { color: #059669; }
    .cuenta-desglose-num.pickit { color: #ea580c; }
    .cuenta-desglose-label { font-size: 11px; color: #6b7280; }
    .cuenta-btn-total { background: #f0fdf4; border-color: #22c55e; }
    .cuenta-btn-total:hover { background: #dcfce7; border-color: #16a34a; }
    .cuenta-btn-total.active { background: #22c55e; border-color: #22c55e; color: white; }
    .resumen-status { padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
    .resumen-status.completo { background: #dcfce7; color: #16a34a; }
    .resumen-status.pendiente { background: #fef3c7; color: #b45309; }
    .resumen-status.vacio { background: #f3f4f6; color: #6b7280; }
    .resumen-pendientes-list { margin-top: 12px; max-height: 150px; overflow-y: auto; }
    .resumen-pendiente-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fef2f2; border-radius: 6px; margin-bottom: 6px; font-size: 13px; cursor: pointer; }
    .resumen-pendiente-item:hover { background: #fee2e2; }
    .resumen-pendiente-item.parcial { background: #fef3c7; }
    .resumen-pendiente-item.parcial:hover { background: #fde68a; }
    .resumen-pendiente-id { font-weight: 600; color: #dc2626; }
    .resumen-pendiente-item.parcial .resumen-pendiente-id { color: #b45309; }
    .resumen-pendiente-cuenta { font-size: 11px; color: #6b7280; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .estado-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .estado-badge.parcial { background: #f59e0b; color: white; }
    .resumen-sync-btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .resumen-sync-btn:hover { background: #1d4ed8; }
    .resumen-sync-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .resumen-sync-btn .spinner { width: 16px; height: 16px; border: 2px solid #ffffff40; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .resumen-sync-btn.loading .spinner { display: block; }
    .resumen-sync-btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sync-progress { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px; overflow: hidden; display: none; }
    .sync-progress.active { display: block; }
    .sync-progress-bar { height: 100%; background: #2563eb; border-radius: 2px; animation: progress 2s ease-in-out infinite; width: 30%; }
    @keyframes progress { 0% { margin-left: 0; } 50% { margin-left: 70%; } 100% { margin-left: 0; } }

    /* Login screen */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-overlay.hidden { display: none; }
    .login-box { background: white; border-radius: 16px; padding: 32px; max-width: 360px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-logo { text-align: center; margin-bottom: 24px; }
    .login-logo h1 { font-size: 24px; color: #2563eb; margin-bottom: 8px; }
    .login-logo p { font-size: 14px; color: #6b7280; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .login-input { padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .login-input:focus { border-color: #2563eb; }
    .login-btn { padding: 14px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .login-btn:hover { background: #1d4ed8; }
    .login-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .login-error { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
    .login-error.show { display: block; }
    .logout-btn { position: fixed; top: 12px; right: 12px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; z-index: 101; transition: background 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .logout-btn.hidden { display: none; }

  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-logo">
        <h1>Verificador de Envios</h1>
        <p>Inicia sesion para continuar</p>
      </div>
      <form class="login-form" id="loginForm">
        <input type="text" class="login-input" id="loginUser" placeholder="Usuario" autocomplete="username" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Contrasena" autocomplete="current-password" required>
        <div class="login-error" id="loginError">Usuario o contrasena incorrectos</div>
        <button type="submit" class="login-btn" id="loginBtn">Iniciar Sesion</button>
      </form>
    </div>
  </div>

  <!-- Logout Button -->
  <button type="button" class="logout-btn hidden" id="logoutBtn">Salir</button>

  <div class="header">
    <h1>Verificador de Envios</h1>
    <div class="nav-tabs">
      <button type="button" class="nav-tab active" id="navPanel" data-view="panel">Panel</button>
      <button type="button" class="nav-tab" id="navVerificar" data-view="verificar">Verificar</button>
    </div>
  </div>
  <div class="container">
    <!-- Vista Panel -->
    <div class="view-section active" id="viewPanel">
    <!-- Resumen del d铆a -->
    <div class="resumen-section" id="resumenSection">
      <div class="resumen-header">
        <h2 id="resumenTitulo">Envios del Dia</h2>
        <span class="resumen-fecha" id="resumenFecha">--/--/----</span>
      </div>
      <div class="resumen-stats">
        <div class="resumen-stat total">
          <div class="resumen-stat-number" id="resumenTotal">-</div>
          <div class="resumen-stat-label">TOTAL</div>
        </div>
        <div class="resumen-stat verificados">
          <div class="resumen-stat-number" id="resumenVerificados">-</div>
          <div class="resumen-stat-label">VERIF</div>
        </div>
        <div class="resumen-stat pendientes">
          <div class="resumen-stat-number" id="resumenPendientes">-</div>
          <div class="resumen-stat-label">PEND</div>
        </div>
      </div>
      <div class="resumen-status vacio" id="resumenStatus">Cargando...</div>
      <div class="cuentas-btns" id="cuentasBtns">
        <button type="button" class="cuenta-btn cuenta-btn-total" data-cuenta="TOTAL">TOTAL</button>
      </div>
      <div class="cuentas-btns" id="cuentasBtnsIndividuales">
        <button type="button" class="cuenta-btn" data-cuenta="TIENDA">TIENDA</button>
        <button type="button" class="cuenta-btn" data-cuenta="SHOP">SHOP</button>
        <button type="button" class="cuenta-btn" data-cuenta="FURST">FURST</button>
        <button type="button" class="cuenta-btn" data-cuenta="MUN1">MUN1</button>
        <button type="button" class="cuenta-btn" data-cuenta="MUN2">MUN2</button>
      </div>
      <div class="cuenta-desglose" id="cuentaDesglose">
        <div class="cuenta-desglose-title" id="cuentaDesgloseTitulo">-</div>
        <div class="cuenta-desglose-items" id="cuentaDesgloseItems">
          <div class="cuenta-desglose-item">
            <div class="cuenta-desglose-num flex" id="cuentaFlex">0</div>
            <div class="cuenta-desglose-label">FLEX</div>
          </div>
          <div class="cuenta-desglose-item" id="cuentaColectaItem">
            <div class="cuenta-desglose-num colecta" id="cuentaColecta">0</div>
            <div class="cuenta-desglose-label" id="cuentaColectaLabel">COLECTA</div>
          </div>
          <div class="cuenta-desglose-item hidden" id="cuentaPickitItem">
            <div class="cuenta-desglose-num pickit" id="cuentaPickit">0</div>
            <div class="cuenta-desglose-label">PICKIT</div>
          </div>
        </div>
      </div>
      <div class="resumen-pendientes-list hidden" id="resumenPendientesList"></div>
      <div style="text-align: center; margin-top: 12px;">
        <button type="button" class="resumen-sync-btn" id="resumenSync">
          <span class="spinner"></span>
          <span class="btn-text">Sincronizar</span>
        </button>
        <div class="sync-progress" id="syncProgress">
          <div class="sync-progress-bar"></div>
        </div>
      </div>
    </div>
    </div>

    <!-- Vista Verificar -->
    <div class="view-section" id="viewVerificar">
    <div class="scan-section">
      <div class="scan-input-group">
        <input type="text" id="shipmentInput" class="scan-input" placeholder="Numero de envio...">
        <button type="button" id="searchBtn" class="scan-btn">Buscar</button>
      </div>
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <canvas id="capturedOverlay"></canvas>
        <div class="photo-thumbnails" id="photoThumbnails"></div>
        <button type="button" class="close-camera" id="closeCamera">X</button>
        <button type="button" class="capture-photo-btn" id="capturePhotoBtn">Analizar con IA</button>
      </div>
      <div class="multi-photo-bar" id="multiPhotoBar">
        <button type="button" class="btn-otra-foto" id="btnOtraFoto">+ Otra foto</button>
        <button type="button" class="btn-enviar-analisis" id="btnEnviarAnalisis">Enviar analisis</button>
      </div>
      <div class="vision-result hidden" id="visionResult">
        <div><strong>Resultado:</strong></div>
        <div class="vision-result-text" id="visionText"></div>
        <div class="vision-result-colors" id="visionColors"></div>
      </div>
    </div>
    <div class="scan-mode-indicator" id="scanModeIndicator">Modo escaneo de productos activo</div>
    <div class="status-message" id="statusMessage"></div>
    <div class="items-section hidden" id="itemsSection">
      <div class="items-header">
        <h2>Productos a verificar</h2>
        <span class="items-count" id="itemsCount">0/0</span>
      </div>
      <div id="itemsList"></div>
    </div>
    <button type="button" class="reset-btn hidden" id="resetBtn">Nuevo envio</button>
    </div>
  </div>
  <div class="complete-banner" id="completeBanner">Envio verificado correctamente</div>
  <div class="complete-banner partial" id="partialBanner">Verificacion parcial guardada</div>
  <button type="button" id="cameraBtn" class="camera-btn">Escanear envio</button>

  <!-- Modal para guardar barcode -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3>Codigo no registrado</h3>
      <p>Este codigo de barras no esta vinculado a ningun SKU. Selecciona el producto correspondiente para guardarlo:</p>
      <div class="modal-barcode" id="modalBarcode"></div>
      <div class="modal-sku-list" id="modalSkuList"></div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn secondary" id="modalCancel">Cancelar</button>
        <button type="button" class="modal-btn primary" id="modalSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal para reportar error de SKU -->
  <div class="modal-overlay" id="errorModalOverlay">
    <div class="error-modal">
      <h3>锔 Reportar error de SKU</h3>
      <div class="error-modal-sku" id="errorModalSku"></div>
      <textarea class="error-modal-note" id="errorModalNote" rows="2" placeholder="Nota opcional (ej: foto no coincide, color incorrecto...)"></textarea>
      <div class="modal-buttons">
        <button type="button" class="modal-btn secondary" id="errorModalCancel">Cancelar</button>
        <button type="button" class="modal-btn primary" style="background:#dc2626" id="errorModalSend">Reportar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    // ============================================
    // SISTEMA DE AUTENTICACIN
    // ============================================
    (function authInit() {
      var loginOverlay = document.getElementById('loginOverlay');
      var loginForm = document.getElementById('loginForm');
      var loginUser = document.getElementById('loginUser');
      var loginPassword = document.getElementById('loginPassword');
      var loginError = document.getElementById('loginError');
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');

      // Verificar si ya est谩 autenticado
      function checkAuth() {
        return fetch('/api/auth/check', { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.authenticated) {
              showApp();
              return true;
            } else {
              showLogin();
              return false;
            }
          })
          .catch(function() {
            showLogin();
            return false;
          });
      }

      // Mostrar pantalla de login
      function showLogin() {
        loginOverlay.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        loginUser.focus();
      }

      // Mostrar app principal
      function showApp() {
        loginOverlay.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        // Iniciar la app principal
        if (typeof initMainApp === 'function') {
          initMainApp();
        }
      }

      // Manejar submit del formulario de login
      loginForm.onsubmit = function(e) {
        e.preventDefault();
        loginError.classList.remove('show');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Ingresando...';

        fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            username: loginUser.value,
            password: loginPassword.value
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';

          if (data.success) {
            loginPassword.value = '';
            showApp();
          } else {
            loginError.textContent = data.error || 'Error al iniciar sesion';
            loginError.classList.add('show');
          }
        })
        .catch(function(err) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';
          loginError.textContent = 'Error de conexion';
          loginError.classList.add('show');
        });
      };

      // Manejar logout
      logoutBtn.onclick = function() {
        fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        })
        .then(function() {
          showLogin();
        })
        .catch(function() {
          showLogin();
        });
      };

      // Verificar autenticaci贸n al cargar
      checkAuth();
    })();

    // ============================================
    // APP PRINCIPAL
    // ============================================
    var mainAppInitialized = false;
    function initMainApp() {
      if (mainAppInitialized) return;
      mainAppInitialized = true;

      var API_URL = '';

      // Wrapper para fetch que incluye credenciales y maneja errores de auth
      function authFetch(url, options) {
        options = options || {};
        options.credentials = 'include';
        return fetch(url, options).then(function(response) {
          if (response.status === 401) {
            // Sesi贸n expirada, recargar para mostrar login
            window.location.reload();
            return Promise.reject(new Error('Sesi贸n expirada'));
          }
          return response;
        });
      }

      var currentItems = [];
      var unitChecks = {};
      var codeReader = null;
      var isScanning = false;
      var currentShipmentId = '';
      var currentAccount = '';
      var alreadySaved = false;
      var scanMode = 'shipment'; // 'shipment' o 'product'
      var pendingBarcode = null;
      var selectedSkuForModal = null;
      var productoAVerificar = null; // Producto seleccionado para verificar con foto

      var shipmentInput = document.getElementById('shipmentInput');
      var searchBtn = document.getElementById('searchBtn');
      var cameraBtn = document.getElementById('cameraBtn');
      var cameraContainer = document.getElementById('cameraContainer');
      var closeCameraBtn = document.getElementById('closeCamera');
      var video = document.getElementById('video');
      var statusMessage = document.getElementById('statusMessage');
      var itemsSection = document.getElementById('itemsSection');
      var itemsList = document.getElementById('itemsList');
      var itemsCount = document.getElementById('itemsCount');
      var completeBanner = document.getElementById('completeBanner');
      var partialBanner = document.getElementById('partialBanner');
      var resetBtn = document.getElementById('resetBtn');
      var scanModeIndicator = document.getElementById('scanModeIndicator');

      // Vision API elements
      var capturePhotoBtn = document.getElementById('capturePhotoBtn');
      var visionResult = document.getElementById('visionResult');
      var visionText = document.getElementById('visionText');
      var visionColors = document.getElementById('visionColors');

      // Navegacion entre vistas
      var navPanel = document.getElementById('navPanel');
      var navVerificar = document.getElementById('navVerificar');
      var viewPanel = document.getElementById('viewPanel');
      var viewVerificar = document.getElementById('viewVerificar');
      var currentView = 'panel';
      var modalOverlay = document.getElementById('modalOverlay');
      var modalBarcode = document.getElementById('modalBarcode');
      var modalSkuList = document.getElementById('modalSkuList');
      var modalCancel = document.getElementById('modalCancel');
      var modalSave = document.getElementById('modalSave');

      // Modal de error SKU
      var errorModalOverlay = document.getElementById('errorModalOverlay');
      var errorModalSku = document.getElementById('errorModalSku');
      var errorModalNote = document.getElementById('errorModalNote');
      var errorModalCancel = document.getElementById('errorModalCancel');
      var errorModalSend = document.getElementById('errorModalSend');
      var pendingErrorSku = null;
      var pendingErrorDesc = null;
      var pendingErrorItemId = null;

      function switchView(view) {
        currentView = view;
        if (view === 'panel') {
          viewPanel.classList.add('active');
          viewVerificar.classList.remove('active');
          navPanel.classList.add('active');
          navVerificar.classList.remove('active');
          // Ocultar boton de camara en vista panel
          cameraBtn.classList.add('hidden');
        } else {
          viewPanel.classList.remove('active');
          viewVerificar.classList.add('active');
          navPanel.classList.remove('active');
          navVerificar.classList.add('active');
          // Mostrar boton de camara en vista verificar
          cameraBtn.classList.remove('hidden');
        }
      }

      navPanel.onclick = function() { switchView('panel'); };
      navVerificar.onclick = function() { switchView('verificar'); };

      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message show ' + type;
        if (type === 'success') {
          setTimeout(hideStatus, 3000);
        }
      }

      function hideStatus() {
        statusMessage.className = 'status-message';
      }

      function isItemComplete(index) {
        var item = currentItems[index];
        var checks = unitChecks[index] || [];
        for (var i = 0; i < item.quantity; i++) {
          var check = checks[i];
          // Soporta tanto boolean como objeto {checked, method}
          var isChecked = check && (check === true || check.checked === true);
          if (!isChecked) return false;
        }
        return true;
      }

      function countCompletedItems() {
        var count = 0;
        for (var i = 0; i < currentItems.length; i++) {
          if (isItemComplete(i)) count++;
        }
        return count;
      }

      function saveVerification(isParcial) {
        if (alreadySaved) return;
        alreadySaved = true;

        // Construir resumen de m茅todos de verificaci贸n por item
        // Excluir 铆tems de verificaci贸n especial (isVerificationOnly) del conteo
        var verificacionDetalle = [];
        var itemsToSave = [];
        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          // Saltar 铆tems de verificaci贸n especial para el registro en Google Sheets
          if (item.isVerificationOnly) continue;

          var checks = unitChecks[i] || [];
          var scannedCount = 0;
          var manualCount = 0;
          for (var j = 0; j < item.quantity; j++) {
            var check = checks[j];
            if (check && check.method === 'scanned') scannedCount++;
            else if (check && check.method === 'manual') manualCount++;
          }
          verificacionDetalle.push({
            sku: item.sku,
            quantity: item.quantity,
            scanned: scannedCount,
            manual: manualCount
          });
          itemsToSave.push(item);
        }

        authFetch(API_URL + '/api/shipment/' + currentShipmentId + '/verificado', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: itemsToSave,
            cuenta: currentAccount,
            verificacionDetalle: verificacionDetalle,
            isParcial: isParcial || false
          })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          // Actualizar el panel para reflejar el cambio
          cargarResumenDia();
          if (isParcial) {
            partialBanner.classList.add('show');
            setTimeout(function() {
              partialBanner.classList.remove('show');
            }, 3000);
          }
        })
        .catch(function(err) {
          console.error('Error guardando verificacion:', err);
        });
      }

      function updateItemsCount() {
        var total = currentItems.length;
        var checked = countCompletedItems();
        itemsCount.textContent = checked + '/' + total;
        if (checked === total && total > 0) {
          completeBanner.classList.add('show');
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          saveVerification(false);
          // Volver al modo de escanear env铆o
          setScanMode('shipment');
        } else {
          completeBanner.classList.remove('show');
        }
      }

      function updateCard(index) {
        var card = document.querySelector('.item-card[data-index="' + index + '"]');
        if (!card) return;
        var mainCheckbox = card.querySelector('.item-main-checkbox');
        var complete = isItemComplete(index);
        mainCheckbox.checked = complete;
        card.className = 'item-card' + (complete ? ' checked' : '');
        updateItemsCount();
      }

      function highlightCard(index) {
        var card = document.querySelector('.item-card[data-index="' + index + '"]');
        if (!card) return;
        card.classList.add('just-scanned');
        setTimeout(function() {
          card.classList.remove('just-scanned');
        }, 2000);
      }

      function renderItems() {
        itemsList.innerHTML = '';
        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          unitChecks[i] = [];

          var card = document.createElement('div');
          card.className = 'item-card';
          if (item.isVerificationOnly) {
            card.classList.add('verification-only');
            card.setAttribute('data-verification-only', 'true');
          }
          card.setAttribute('data-index', i);
          card.setAttribute('data-sku', item.sku);

          var mainCheckbox = document.createElement('input');
          mainCheckbox.type = 'checkbox';
          mainCheckbox.className = 'item-main-checkbox';
          mainCheckbox.checked = false;

          var info = document.createElement('div');
          info.className = 'item-info';

          var descDiv = document.createElement('div');
          descDiv.className = 'item-description';
          descDiv.textContent = item.description || item.title || item.sku;
          if (item.isKit) {
            var badge = document.createElement('span');
            badge.className = 'item-kit-badge';
            badge.textContent = 'KIT';
            descDiv.appendChild(badge);
          }

          var skuDiv = document.createElement('div');
          skuDiv.className = 'item-sku';
          // No mostrar SKU para 铆tems de verificaci贸n especial
          skuDiv.textContent = item.isVerificationOnly ? '锔 Verificaci贸n adicional' : 'SKU: ' + item.sku;

          var qtyDiv = document.createElement('div');
          qtyDiv.className = 'item-quantity';
          // Usar displayQuantity si existe (para 铆tems de verificaci贸n), sino quantity
          var displayQty = item.displayQuantity !== undefined ? item.displayQuantity : item.quantity;
          qtyDiv.textContent = 'Cantidad: ' + displayQty;

          var unitsDiv = document.createElement('div');
          unitsDiv.className = 'unit-checkboxes';

          for (var j = 0; j < item.quantity; j++) {
            var unitCb = document.createElement('input');
            unitCb.type = 'checkbox';
            unitCb.className = 'unit-checkbox';
            unitCb.setAttribute('data-item', i);
            unitCb.setAttribute('data-unit', j);
            unitsDiv.appendChild(unitCb);
          }

          info.appendChild(descDiv);
          info.appendChild(skuDiv);
          info.appendChild(qtyDiv);
          info.appendChild(unitsDiv);
          card.appendChild(mainCheckbox);
          card.appendChild(info);

          // Bot贸n para verificar con foto (solo para 铆tems normales, no para verificaci贸n especial)
          if (!item.isVerificationOnly) {
            var verifyBtn = document.createElement('button');
            verifyBtn.className = 'verify-photo-btn';
            verifyBtn.textContent = '';
            verifyBtn.title = 'Verificar con foto';
            verifyBtn.setAttribute('data-index', i);
            verifyBtn.onclick = function(e) {
              e.stopPropagation();
              var idx = parseInt(this.getAttribute('data-index'));
              iniciarVerificacionFoto(idx);
            };
            card.appendChild(verifyBtn);
          }

          // Bot贸n peque帽o para reportar error de SKU (muy discreto)
          var reportBtn = document.createElement('button');
          reportBtn.className = 'report-error-btn';
          reportBtn.textContent = '锔';
          reportBtn.title = 'Reportar error de SKU';
          reportBtn.setAttribute('data-sku', item.sku);
          reportBtn.setAttribute('data-desc', item.description || item.title || '');
          reportBtn.setAttribute('data-item-id', item.id || '');
          reportBtn.onclick = function(e) {
            e.stopPropagation();
            var sku = this.getAttribute('data-sku');
            var desc = this.getAttribute('data-desc');
            var itemId = this.getAttribute('data-item-id');
            showErrorModal(sku, desc, itemId);
          };
          card.appendChild(reportBtn);

          itemsList.appendChild(card);
        }
        updateItemsCount();
      }

      itemsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('unit-checkbox')) {
          var itemIndex = parseInt(e.target.getAttribute('data-item'));
          var unitIndex = parseInt(e.target.getAttribute('data-unit'));
          if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];
          // Registrar m茅todo manual
          unitChecks[itemIndex][unitIndex] = e.target.checked ? { checked: true, method: 'manual' } : null;
          updateCard(itemIndex);
        }
      });

      function searchShipment(shipmentId) {
        // Guardar parcial del env铆o anterior si corresponde
        savePartialIfNeeded();

        if (!shipmentId || shipmentId.trim() === '') {
          showStatus('Ingresa un numero de envio', 'error');
          return;
        }
        showStatus('Buscando envio...', 'loading');
        searchBtn.disabled = true;
        searchBtn.textContent = '...';
        authFetch(API_URL + '/api/shipment/' + shipmentId.trim())
          .then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) throw new Error(data.error || 'Error al buscar envio');
              return data;
            });
          })
          .then(function(data) {
            currentItems = data.items;
            unitChecks = {};
            currentShipmentId = shipmentId.trim();
            currentAccount = data.account;
            alreadySaved = false;
            hideStatus();
            itemsSection.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            renderItems();
            stopCamera();
            // Cambiar a modo escaneo de productos
            setScanMode('product');
            // Asegurar que estamos en la vista verificar
            switchView('verificar');
          })
          .catch(function(error) {
            showStatus(error.message, 'error');
            itemsSection.classList.add('hidden');
          })
          .finally(function() {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Buscar';
          });
      }

      function extractShipmentId(texto) {
        if (texto.indexOf('"id"') > -1) {
          var match = texto.match(/"id"\s*:\s*"(\d+)"/);
          if (match) return match[1];
        }
        if (texto.indexOf('shipment_id=') > -1) {
          var match = texto.match(/shipment_id=(\d+)/);
          if (match) return match[1];
        }
        if (texto.indexOf('/shipments/') > -1) {
          var match = texto.match(/\/shipments\/(\d+)/);
          if (match) return match[1];
        }
        return texto;
      }

      function setScanMode(mode) {
        scanMode = mode;
        if (mode === 'product') {
          cameraBtn.textContent = 'Escanear producto';
          cameraBtn.classList.add('product-mode');
          scanModeIndicator.classList.add('show');
        } else {
          cameraBtn.textContent = 'Escanear envio';
          cameraBtn.classList.remove('product-mode');
          scanModeIndicator.classList.remove('show');
        }
      }

      function findItemBySku(sku) {
        for (var i = 0; i < currentItems.length; i++) {
          if (currentItems[i].sku === sku) {
            return i;
          }
        }
        return -1;
      }

      function findNextUncheckedUnit(itemIndex) {
        var item = currentItems[itemIndex];
        var checks = unitChecks[itemIndex] || [];
        for (var i = 0; i < item.quantity; i++) {
          var check = checks[i];
          // Soporta tanto boolean como objeto {checked, method}
          var isChecked = check && (check === true || check.checked === true);
          if (!isChecked) return i;
        }
        return -1;
      }

      function markProductByBarcode(barcode) {
        authFetch(API_URL + '/api/barcode/' + encodeURIComponent(barcode))
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.found && data.sku) {
              // Encontramos el SKU para este barcode
              var itemIndex = findItemBySku(data.sku);
              if (itemIndex >= 0) {
                var unitIndex = findNextUncheckedUnit(itemIndex);
                if (unitIndex >= 0) {
                  // Marcar la unidad con m茅todo escaneado
                  if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];
                  unitChecks[itemIndex][unitIndex] = { checked: true, method: 'scanned' };

                  // Actualizar UI
                  var checkbox = document.querySelector('.unit-checkbox[data-item="' + itemIndex + '"][data-unit="' + unitIndex + '"]');
                  if (checkbox) {
                    checkbox.checked = true;
                    checkbox.classList.add('scanned');
                    setTimeout(function() { checkbox.classList.remove('scanned'); }, 2000);
                  }

                  updateCard(itemIndex);
                  highlightCard(itemIndex);

                  showStatus('OK: ' + data.sku, 'success');
                  if (navigator.vibrate) navigator.vibrate(100);
                } else {
                  showStatus('Producto ya verificado: ' + data.sku, 'error');
                  if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                }
              } else {
                showStatus('SKU no esta en este envio: ' + data.sku, 'error');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
              }
            } else {
              // Barcode no registrado, mostrar modal para guardarlo
              showBarcodeModal(barcode);
            }
          })
          .catch(function(err) {
            showStatus('Error al verificar codigo', 'error');
            console.error(err);
          });
      }

      function showBarcodeModal(barcode) {
        pendingBarcode = barcode;
        selectedSkuForModal = null;
        modalBarcode.textContent = barcode;

        // Mostrar lista de SKUs del env铆o actual
        modalSkuList.innerHTML = '';
        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          var option = document.createElement('div');
          option.className = 'modal-sku-option';
          option.setAttribute('data-sku', item.sku);
          option.setAttribute('data-index', i);

          var name = document.createElement('div');
          name.className = 'modal-sku-name';
          name.textContent = item.sku;

          var desc = document.createElement('div');
          desc.className = 'modal-sku-desc';
          desc.textContent = item.description || item.title || '';

          option.appendChild(name);
          option.appendChild(desc);
          modalSkuList.appendChild(option);

          option.onclick = function() {
            var allOptions = modalSkuList.querySelectorAll('.modal-sku-option');
            for (var j = 0; j < allOptions.length; j++) {
              allOptions[j].classList.remove('selected');
            }
            this.classList.add('selected');
            selectedSkuForModal = this.getAttribute('data-sku');
          };
        }

        modalOverlay.classList.add('show');
      }

      function hideBarcodeModal() {
        modalOverlay.classList.remove('show');
        pendingBarcode = null;
        selectedSkuForModal = null;
      }

      function saveBarcodeMapping() {
        if (!pendingBarcode || !selectedSkuForModal) {
          showStatus('Selecciona un SKU', 'error');
          return;
        }

        var item = currentItems.find(function(i) { return i.sku === selectedSkuForModal; });
        var description = item ? (item.description || item.title || '') : '';

        authFetch(API_URL + '/api/barcode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: pendingBarcode,
            sku: selectedSkuForModal,
            description: description
          })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success) {
            showStatus('Guardado: ' + pendingBarcode + ' -> ' + selectedSkuForModal, 'success');
            // Marcar el producto automaticamente
            markProductByBarcode(pendingBarcode);
          } else {
            showStatus('Error al guardar', 'error');
          }
          hideBarcodeModal();
        })
        .catch(function(err) {
          showStatus('Error al guardar', 'error');
          hideBarcodeModal();
        });
      }

      modalCancel.onclick = hideBarcodeModal;
      modalSave.onclick = saveBarcodeMapping;

      // Funciones del modal de error SKU
      function showErrorModal(sku, description, itemId) {
        pendingErrorSku = sku;
        pendingErrorDesc = description;
        pendingErrorItemId = itemId || null;
        errorModalSku.textContent = sku + (description ? ' - ' + description : '');
        errorModalNote.value = '';
        errorModalOverlay.classList.add('show');
      }

      function hideErrorModal() {
        errorModalOverlay.classList.remove('show');
        pendingErrorSku = null;
        pendingErrorDesc = null;
        pendingErrorItemId = null;
      }

      function sendErrorReport() {
        if (!pendingErrorSku) return;

        var nota = errorModalNote.value.trim();

        authFetch(API_URL + '/api/error-sku', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sku: pendingErrorSku,
            descripcion: pendingErrorDesc || '',
            nota: nota,
            envioId: currentShipmentId,
            cuenta: currentAccount,
            itemId: pendingErrorItemId || ''
          })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.ok) {
            showStatus('Error reportado: ' + pendingErrorSku, 'success');
          } else {
            showStatus('Error al reportar', 'error');
          }
          hideErrorModal();
        })
        .catch(function(err) {
          showStatus('Error al reportar', 'error');
          hideErrorModal();
        });
      }

      errorModalCancel.onclick = hideErrorModal;
      errorModalSend.onclick = sendErrorReport;

      function handleScan(result) {
        var texto = result.getText();

        if (scanMode === 'shipment') {
          // Modo escaneo de env铆o
          isScanning = false;
          var shipmentId = extractShipmentId(texto);
          shipmentInput.value = shipmentId;
          stopCamera();
          searchShipment(shipmentId);
        } else {
          // Modo escaneo de producto
          isScanning = false;
          stopCamera();
          markProductByBarcode(texto.trim());
        }
      }

      function startCamera() {
        if (typeof ZXing === 'undefined') {
          showStatus('Error: libreria de camara no cargada', 'error');
          return;
        }
        if (!codeReader) {
          var hints = new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.QR_CODE,
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.CODE_39,
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.UPC_A,
            ZXing.BarcodeFormat.UPC_E,
            ZXing.BarcodeFormat.ITF
          ]);
          hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
          codeReader = new ZXing.BrowserMultiFormatReader(hints, 500);
        }
        cameraContainer.classList.add('active');
        cameraBtn.classList.add('hidden');
        isScanning = true;

        // Intentar usar la c谩mara trasera con mejor resoluci贸n
        var constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            focusMode: { ideal: 'continuous' }
          }
        };

        codeReader.decodeFromConstraints(constraints, 'video', function(result, error) {
          if (result && isScanning) {
            handleScan(result);
          }
        }).catch(function(err) {
          // Si falla con constraints, intentar sin ellos
          codeReader.decodeFromVideoDevice(null, 'video', function(result, error) {
            if (result && isScanning) {
              handleScan(result);
            }
          }).catch(function(err2) {
            showStatus('No se pudo acceder a la camara', 'error');
            stopCamera();
          });
        });
      }

      function stopCamera() {
        isScanning = false;
        cameraContainer.classList.remove('active');
        cameraBtn.classList.remove('hidden');
        if (codeReader) codeReader.reset();
        visionResult.classList.add('hidden');
        unfreezeCamera();
      }

      // ============================================
      // FREEZE & MULTI-FOTO
      // ============================================

      var capturedImages = [];
      var capturedOverlay = document.getElementById('capturedOverlay');
      var multiPhotoBar = document.getElementById('multiPhotoBar');
      var photoThumbnails = document.getElementById('photoThumbnails');
      var btnOtraFoto = document.getElementById('btnOtraFoto');
      var btnEnviarAnalisis = document.getElementById('btnEnviarAnalisis');

      function freezeCamera(canvas) {
        capturedOverlay.width = canvas.width;
        capturedOverlay.height = canvas.height;
        var overlayCtx = capturedOverlay.getContext('2d');
        overlayCtx.drawImage(canvas, 0, 0);
        cameraContainer.classList.add('frozen');
      }

      function unfreezeCamera() {
        cameraContainer.classList.remove('frozen');
        multiPhotoBar.classList.remove('active');
        capturedImages = [];
        photoThumbnails.innerHTML = '';
      }

      function addThumbnail(imageBase64) {
        var img = document.createElement('img');
        img.src = imageBase64;
        img.className = 'photo-thumb';
        photoThumbnails.appendChild(img);
      }

      function showMultiPhotoBar() {
        capturePhotoBtn.style.display = 'none';
        multiPhotoBar.classList.add('active');

        // Evaluar fotos m铆nimas
        var minFotos = (productoAVerificar && productoAVerificar.fotosMinimas) || 1;
        var faltan = minFotos - capturedImages.length;
        if (faltan > 0) {
          btnEnviarAnalisis.disabled = true;
          btnEnviarAnalisis.textContent = 'Falta' + (faltan > 1 ? 'n ' : ' ') + faltan + ' foto' + (faltan > 1 ? 's' : '');
        } else {
          btnEnviarAnalisis.disabled = false;
          btnEnviarAnalisis.textContent = 'Enviar analisis';
        }
      }

      function hideMultiPhotoBar() {
        multiPhotoBar.classList.remove('active');
        capturePhotoBtn.style.display = '';
        // Restaurar estado del bot贸n
        btnEnviarAnalisis.disabled = false;
        btnEnviarAnalisis.textContent = 'Enviar analisis';
      }

      btnOtraFoto.onclick = function() {
        // Descongelar para tomar otra foto
        cameraContainer.classList.remove('frozen');
        hideMultiPhotoBar();
        capturePhotoBtn.disabled = false;
        capturePhotoBtn.textContent = 'Tomar otra foto';
      };

      btnEnviarAnalisis.onclick = function() {
        sendImagesToAnalyze(capturedImages);
      };

      function sendImagesToAnalyze(images) {
        hideMultiPhotoBar();
        capturePhotoBtn.disabled = true;
        capturePhotoBtn.style.display = '';
        capturePhotoBtn.textContent = 'Analizando...';
        showStatus('Claude esta analizando ' + images.length + ' foto(s)...', 'loading');

        var requestBody = { images: images };
        if (productoAVerificar) {
          requestBody.producto = {
            descripcion: productoAVerificar.descripcion,
            sku: productoAVerificar.item ? productoAVerificar.item.sku : ''
          };
        }

        authFetch(API_URL + '/api/vision/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          capturePhotoBtn.disabled = false;
          capturePhotoBtn.textContent = 'Analizar con IA';
          unfreezeCamera();

          console.log('Respuesta IA:', data);

          if (data.success) {
            if (data.codigoRotuladora && data.skuVinculado) {
              console.log('PRIORIDAD 1: C贸digo rotuladora detectado', data.codigoRotuladora, data.skuVinculado);
              showVisionResultWithRotuladora(data);
              if (scanMode === 'product') {
                tryMatchBySku(data.skuVinculado, data.codigoRotuladora);
              }
            } else if (productoAVerificar && data.correcto !== undefined) {
              mostrarResultadoVerificacion(data);
            } else {
              showVisionResult(data);
              if (scanMode === 'product') {
                if (data.modeloDetectado) {
                  tryMatchModelWithItems(data.modeloDetectado, data.colorDetectado);
                }
              }
            }
          } else {
            showStatus('Error: ' + (data.error || 'Error desconocido'), 'error');
          }
        })
        .catch(function(err) {
          capturePhotoBtn.disabled = false;
          capturePhotoBtn.textContent = 'Analizar con IA';
          unfreezeCamera();
          showStatus('Error de conexion', 'error');
          console.error(err);
        });
      }

      // ============================================
      // VISION API - Verificaci贸n inteligente con Claude
      // ============================================

      function iniciarVerificacionFoto(itemIndex) {
        productoAVerificar = {
          index: itemIndex,
          item: currentItems[itemIndex],
          descripcion: currentItems[itemIndex].description || currentItems[itemIndex].title || currentItems[itemIndex].sku,
          fotosMinimas: 1
        };
        showStatus('Verificando: ' + productoAVerificar.descripcion, 'loading');

        // Consultar fotos m铆nimas para este tipo de producto
        var sku = productoAVerificar.item ? productoAVerificar.item.sku : '';
        var desc = productoAVerificar.descripcion;
        authFetch(API_URL + '/api/product-config?sku=' + encodeURIComponent(sku) + '&descripcion=' + encodeURIComponent(desc))
          .then(function(r) { return r.json(); })
          .then(function(cfg) {
            if (productoAVerificar) {
              productoAVerificar.fotosMinimas = cfg.fotosMinimas || 1;
              if (cfg.fotosMaximas) productoAVerificar.fotosMaximas = cfg.fotosMaximas;
            }
          })
          .catch(function() {}); // Si falla, queda en 1

        // Abrir c谩mara en modo producto
        scanMode = 'product';
        startCamera();

        // Scroll suave a la c谩mara
        setTimeout(function() {
          cameraContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      function capturePhoto() {
        if (!video.srcObject) {
          showStatus('Camara no activa', 'error');
          return;
        }

        // Crear canvas para capturar el frame
        var canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Convertir a base64
        var imageBase64 = canvas.toDataURL('image/jpeg', 0.8);

        // Congelar c谩mara con la foto capturada
        freezeCamera(canvas);

        // Guardar imagen en el array
        capturedImages.push(imageBase64);
        addThumbnail(imageBase64);

        // Si el producto tiene fotosMaximas y ya se alcanz贸, enviar directo
        var maxFotos = productoAVerificar && productoAVerificar.fotosMaximas;
        if (maxFotos && capturedImages.length >= maxFotos) {
          showStatus('Foto capturada, enviando a analizar...', 'success');
          sendImagesToAnalyze(capturedImages);
          return;
        }

        // Mostrar botones multi-foto
        showMultiPhotoBar();
        showStatus('Foto ' + capturedImages.length + ' capturada', 'success');
      }

      function mostrarResultadoVerificacion(data) {
        stopCamera();

        if (data.correcto) {
          //  Producto correcto - marcar autom谩ticamente
          showStatus(' CORRECTO: ' + data.productoDetectado, 'success');
          marcarProductoVerificado(productoAVerificar.index, 'claude');
        } else {
          //  Producto incorrecto
          showStatus(' INCORRECTO: ' + (data.motivo || 'No coincide'), 'error');
        }

        // Mostrar detalles
        visionText.textContent = 'Modelo: ' + (data.modeloDetectado || '?') + ' | Color: ' + (data.colorDetectado || '?');
        visionColors.innerHTML = '<strong>Confianza:</strong> ' + (data.confianza || 'media');
        visionResult.classList.remove('hidden');

        // Limpiar producto a verificar
        productoAVerificar = null;
      }

      function marcarProductoVerificado(itemIndex, method) {
        var item = currentItems[itemIndex];
        if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];

        // Marcar solo la primera unidad no verificada
        for (var j = 0; j < item.quantity; j++) {
          if (!unitChecks[itemIndex][j] || !unitChecks[itemIndex][j].checked) {
            unitChecks[itemIndex][j] = { checked: true, method: method };
            // Actualizar checkbox en UI
            var checkbox = document.querySelector('.unit-checkbox[data-item="' + itemIndex + '"][data-unit="' + j + '"]');
            if (checkbox) {
              checkbox.checked = true;
              checkbox.classList.add('scanned');
              setTimeout(function() { checkbox.classList.remove('scanned'); }, 2000);
            }
            break; // Solo marcar una
          }
        }

        updateCard(itemIndex);
        highlightCard(itemIndex);
        updateItemsCount();
      }

      function tryMatchBySku(skuVinculado, codigoRotuladora) {
        var skuUpper = skuVinculado.toUpperCase();

        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          var itemSku = (item.sku || '').toUpperCase();
          var itemDesc = (item.description || '').toUpperCase();

          // Buscar coincidencia en SKU o descripci贸n
          if (itemSku === skuUpper || itemSku.indexOf(skuUpper) !== -1 ||
              skuUpper.indexOf(itemSku) !== -1 || itemDesc.indexOf(skuUpper) !== -1) {
            showStatus('Match por c贸digo: ' + item.description, 'success');
            marcarProductoVerificado(i, 'rotuladora');
            return;
          }
        }

        showStatus('SKU ' + skuVinculado + ' (c贸digo ' + codigoRotuladora + ') no encontrado', 'error');
      }

      function tryMatchModelWithItems(modelo, color) {
        if (!modelo) return;
        var modeloUpper = modelo.toUpperCase();

        for (var i = 0; i < currentItems.length; i++) {
          var desc = (currentItems[i].description || '').toUpperCase();
          if (desc.indexOf(modeloUpper) !== -1 || modeloUpper.indexOf(desc.split(' ').pop()) !== -1) {
            // Encontr贸 match
            showStatus('Match encontrado: ' + currentItems[i].description, 'success');
            marcarProductoVerificado(i, 'claude-auto');
            return;
          }
        }
        showStatus('Modelo detectado: ' + modelo + ' (sin match autom谩tico)', 'info');
      }

      function showVisionResult(data) {
        // Mostrar info de Claude (modelo, color, tipo)
        var info = [];
        if (data.modeloDetectado) info.push('Modelo: ' + data.modeloDetectado);
        if (data.colorDetectado) info.push('Color: ' + data.colorDetectado);
        if (data.tipoProducto) info.push('Tipo: ' + data.tipoProducto);

        visionText.textContent = info.length > 0 ? info.join(' | ') : '(sin datos)';
        visionColors.innerHTML = data.confianza ? '<strong>Confianza:</strong> ' + data.confianza : '';

        visionResult.classList.remove('hidden');
        hideStatus();
      }

      function showVisionResultWithRotuladora(data) {
        // Mostrar c贸digo de rotuladora y SKU vinculado
        visionText.innerHTML = '<strong>C贸digo:</strong> ' + data.codigoRotuladora + '<br><strong>SKU:</strong> ' + data.skuVinculado;
        visionColors.innerHTML = '<strong>Confianza:</strong> ' + (data.confianza || 'alta');
        visionResult.classList.remove('hidden');
        showStatus(' C贸digo rotuladora detectado: ' + data.codigoRotuladora, 'success');
      }

      capturePhotoBtn.onclick = capturePhoto;

      function savePartialIfNeeded() {
        // Guardar verificaci贸n parcial autom谩ticamente si hay items verificados pero no todos
        if (alreadySaved || !currentShipmentId || currentItems.length === 0) return;

        var checked = countCompletedItems();
        var total = currentItems.length;

        // Si hay al menos un item verificado pero no todos, guardar como parcial
        if (checked > 0 && checked < total) {
          saveVerification(true);
        }
      }

      function reset() {
        // Guardar parcial autom谩ticamente antes de resetear
        savePartialIfNeeded();

        currentItems = [];
        unitChecks = {};
        currentShipmentId = '';
        currentAccount = '';
        alreadySaved = false;
        shipmentInput.value = '';
        itemsSection.classList.add('hidden');
        resetBtn.classList.add('hidden');
        completeBanner.classList.remove('show');
        partialBanner.classList.remove('show');
        visionResult.classList.add('hidden');
        hideStatus();
        setScanMode('shipment');
        shipmentInput.focus();
      }

      searchBtn.onclick = function() { searchShipment(shipmentInput.value); };
      shipmentInput.onkeypress = function(e) { if (e.key === 'Enter') searchShipment(shipmentInput.value); };
      cameraBtn.onclick = startCamera;
      closeCameraBtn.onclick = stopCamera;
      resetBtn.onclick = reset;

      // ============================================
      // RESUMEN DEL DA
      // ============================================
      var resumenFecha = document.getElementById('resumenFecha');
      var resumenTotal = document.getElementById('resumenTotal');
      var resumenVerificados = document.getElementById('resumenVerificados');
      var resumenPendientes = document.getElementById('resumenPendientes');
      var resumenStatus = document.getElementById('resumenStatus');
      var resumenPendientesList = document.getElementById('resumenPendientesList');
      var cuentasBtns = document.getElementById('cuentasBtns');
      var cuentasBtnsIndividuales = document.getElementById('cuentasBtnsIndividuales');
      var cuentaDesglose = document.getElementById('cuentaDesglose');
      var cuentaDesgloseTitulo = document.getElementById('cuentaDesgloseTitulo');
      var cuentaFlex = document.getElementById('cuentaFlex');
      var cuentaColecta = document.getElementById('cuentaColecta');
      var cuentaColectaLabel = document.getElementById('cuentaColectaLabel');
      var cuentaColectaItem = document.getElementById('cuentaColectaItem');
      var cuentaPickit = document.getElementById('cuentaPickit');
      var cuentaPickitItem = document.getElementById('cuentaPickitItem');

      var enviosDelDia = []; // Guardar env铆os para filtrar por cuenta
      var cuentaSeleccionada = null;

      // Cuentas que usan COLECTA vs PICKIT
      var cuentasColecta = ['TIENDA', 'FURST'];
      var cuentasPickit = ['SHOP', 'MUN1', 'MUN2'];

      function cargarResumenDia() {
        authFetch(API_URL + '/api/envios-del-dia')
          .then(function(response) { return response.json(); })
          .then(function(data) {
            var now = new Date();
            resumenFecha.textContent = now.toLocaleDateString('es-AR');
            resumenTotal.textContent = data.total || 0;

            enviosDelDia = data.envios || [];

            // Contar verificados, parciales y pendientes seg煤n el estado
            var verificados = 0;
            var parciales = 0;
            var pendientes = 0;
            var enviosPendientes = [];

            for (var i = 0; i < enviosDelDia.length; i++) {
              var estado = enviosDelDia[i].estado || 'Pendiente';
              if (estado === 'Verificado') {
                verificados++;
              } else if (estado.indexOf('Parcial') === 0) {
                parciales++;
                enviosPendientes.push(enviosDelDia[i]);
              } else if (estado === 'Pendiente') {
                pendientes++;
                enviosPendientes.push(enviosDelDia[i]);
              }
              // Los despachados/entregados no se cuentan como pendientes
            }

            resumenVerificados.textContent = verificados;
            resumenPendientes.textContent = pendientes + parciales;

            resumenStatus.className = 'resumen-status';
            if (data.total === 0) {
              resumenStatus.classList.add('vacio');
              resumenStatus.textContent = 'No hay envios del dia';
              resumenPendientesList.classList.add('hidden');
              cuentaDesglose.classList.remove('show');
            } else if (pendientes === 0 && parciales === 0) {
              resumenStatus.classList.add('completo');
              resumenStatus.textContent = 'Todos verificados (' + verificados + ')';
              resumenPendientesList.classList.add('hidden');
            } else {
              resumenStatus.classList.add('pendiente');
              var statusText = pendientes + ' pendiente(s), ' + verificados + ' verificado(s)';
              if (parciales > 0) {
                statusText += ', ' + parciales + ' parcial(es)';
              }
              resumenStatus.textContent = statusText;
              mostrarListaPendientes(enviosPendientes);
            }

            // Si hay cuenta seleccionada, actualizar desglose
            if (cuentaSeleccionada) {
              if (cuentaSeleccionada === 'TOTAL') {
                mostrarDesgloseTotal();
              } else {
                mostrarDesgloseCuenta(cuentaSeleccionada);
              }
            }
          })
          .catch(function(err) {
            resumenStatus.className = 'resumen-status vacio';
            resumenStatus.textContent = 'Error cargando envios';
            console.error(err);
          });
      }

      function mostrarListaPendientes(envios) {
        resumenPendientesList.innerHTML = '';
        if (envios.length > 0) {
          resumenPendientesList.classList.remove('hidden');
          for (var i = 0; i < envios.length; i++) {
            var p = envios[i];
            var item = document.createElement('div');
            item.className = 'resumen-pendiente-item';
            var estado = p.estado || 'Pendiente';
            if (estado.indexOf('Parcial') === 0) {
              item.classList.add('parcial');
            }
            item.setAttribute('data-id', p.id);
            var estadoBadge = estado.indexOf('Parcial') === 0 ? '<span class="estado-badge parcial">' + estado + '</span>' : '';
            item.innerHTML = '<span class="resumen-pendiente-id">' + p.id + '</span><span class="resumen-pendiente-cuenta">' + p.cuenta + ' - ' + (p.receptor || '') + estadoBadge + '</span>';
            item.onclick = function() {
              var id = this.getAttribute('data-id');
              shipmentInput.value = id;
              searchShipment(id);
            };
            resumenPendientesList.appendChild(item);
          }
        } else {
          resumenPendientesList.classList.add('hidden');
        }
      }

      function mostrarDesgloseTotal() {
        var flexCount = 0;
        var colectaCount = 0;
        var pickitCount = 0;

        for (var i = 0; i < enviosDelDia.length; i++) {
          var e = enviosDelDia[i];
          if (e.logisticType === 'self_service') {
            flexCount++;
          } else if (e.logisticType === 'cross_docking') {
            colectaCount++;
          } else {
            pickitCount++;
          }
        }

        cuentaDesgloseTitulo.textContent = 'TOTAL (' + enviosDelDia.length + ' envios)';
        cuentaFlex.textContent = flexCount;
        cuentaColecta.textContent = colectaCount;
        cuentaColectaLabel.textContent = 'COLECTA';
        cuentaColectaItem.classList.remove('hidden');
        cuentaPickit.textContent = pickitCount;
        cuentaPickitItem.classList.remove('hidden');
        cuentaDesglose.classList.add('show');

        mostrarListaPendientes(enviosDelDia);
      }

      function mostrarDesgloseCuenta(cuenta) {
        var enviosCuenta = enviosDelDia.filter(function(e) { return e.cuenta === cuenta; });
        var flexCount = 0;
        var otrosCount = 0;

        var usaColecta = cuentasColecta.indexOf(cuenta) !== -1;

        for (var i = 0; i < enviosCuenta.length; i++) {
          if (enviosCuenta[i].logisticType === 'self_service') {
            flexCount++;
          } else {
            otrosCount++;
          }
        }

        cuentaDesgloseTitulo.textContent = cuenta + ' (' + enviosCuenta.length + ' envios)';
        cuentaFlex.textContent = flexCount;
        cuentaColecta.textContent = otrosCount;
        cuentaColectaLabel.textContent = usaColecta ? 'COLECTA' : 'PICKIT';
        cuentaColectaItem.classList.remove('hidden');
        cuentaPickitItem.classList.add('hidden');
        cuentaDesglose.classList.add('show');

        // Mostrar solo los pendientes de esta cuenta
        mostrarListaPendientes(enviosCuenta);
      }

      // Deseleccionar todos los botones
      function deseleccionarTodos() {
        var allBtns = document.querySelectorAll('.cuenta-btn');
        for (var i = 0; i < allBtns.length; i++) {
          allBtns[i].classList.remove('active');
        }
      }

      // Manejar click en bot贸n TOTAL
      function handleCuentaClick(e) {
        if (!e.target.classList.contains('cuenta-btn')) return;

        var cuenta = e.target.getAttribute('data-cuenta');

        // Toggle: si ya est谩 seleccionada, deseleccionar
        if (cuentaSeleccionada === cuenta) {
          cuentaSeleccionada = null;
          e.target.classList.remove('active');
          cuentaDesglose.classList.remove('show');
          mostrarListaPendientes(enviosDelDia);
        } else {
          // Deseleccionar todos
          deseleccionarTodos();
          // Seleccionar nuevo
          e.target.classList.add('active');
          cuentaSeleccionada = cuenta;

          if (cuenta === 'TOTAL') {
            mostrarDesgloseTotal();
          } else {
            mostrarDesgloseCuenta(cuenta);
          }
        }
      }

      cuentasBtns.onclick = handleCuentaClick;
      cuentasBtnsIndividuales.onclick = handleCuentaClick;

      // Sincronizar env铆os (trae nuevos + actualiza estados)
      var resumenSync = document.getElementById('resumenSync');
      var syncProgress = document.getElementById('syncProgress');

      resumenSync.onclick = function() {
        resumenSync.classList.add('loading');
        resumenSync.disabled = true;
        syncProgress.classList.add('active');
        resumenStatus.className = 'resumen-status vacio';
        resumenStatus.textContent = 'Sincronizando envios con MercadoLibre...';

        authFetch(API_URL + '/api/sync-morning')
          .then(function(response) { return response.json(); })
          .then(function(data) {
            resumenSync.classList.remove('loading');
            resumenSync.disabled = false;
            syncProgress.classList.remove('active');

            if (data.success) {
              resumenStatus.className = 'resumen-status completo';
              var msg = 'Sincronizado';
              if (data.estadosActualizados > 0) {
                msg += ' (' + data.estadosActualizados + ' estado(s) actualizado(s))';
              }
              resumenStatus.textContent = msg;
              cargarResumenDia();
            } else {
              resumenStatus.className = 'resumen-status vacio';
              resumenStatus.textContent = 'Error: ' + (data.error || 'Error desconocido');
            }
          })
          .catch(function(err) {
            resumenSync.classList.remove('loading');
            resumenSync.disabled = false;
            syncProgress.classList.remove('active');
            resumenStatus.className = 'resumen-status vacio';
            resumenStatus.textContent = 'Error de conexion';
            console.error(err);
          });
      };

      // Cargar resumen al iniciar
      cargarResumenDia();

      // Inicializar vista (ocultar boton de camara en vista panel)
      cameraBtn.classList.add('hidden');

      console.log('App iniciada v19 - Login de usuario agregado');
    }
  </script>
</body>
</html>
