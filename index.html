<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Verificador de Envios</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      padding-bottom: 100px;
    }
    
    .header {
      background: #2563eb;
      color: white;
      padding: 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .account-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .container {
      padding: 16px;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .scan-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .scan-input-group {
      display: flex;
      gap: 8px;
    }
    
    .scan-input {
      flex: 1;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .scan-input:focus {
      border-color: #2563eb;
    }
    
    .scan-btn {
      padding: 14px 20px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .scan-btn:active {
      background: #1d4ed8;
    }
    
    .scan-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .camera-btn {
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      background: #059669;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .camera-btn:active {
      background: #047857;
    }
    
    .camera-container {
      display: none;
      margin-top: 16px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .camera-container.active {
      display: block;
    }
    
    #video {
      width: 100%;
      border-radius: 8px;
    }
    
    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 100px;
      border: 3px solid #22c55e;
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    }
    
    .close-camera {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
    }
    
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    .status-message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .status-message.success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }
    
    .status-message.loading {
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }
    
    .items-section {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .items-header {
      padding: 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .items-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
    }
    
    .items-count {
      font-size: 14px;
      color: #6b7280;
    }
    
    .item-card {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: background 0.2s;
    }
    
    .item-card:last-child {
      border-bottom: none;
    }
    
    .item-card.checked {
      background: #f0fdf4;
    }
    
    .item-checkbox {
      width: 28px;
      height: 28px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: #22c55e;
    }
    
    .item-info {
      flex: 1;
    }
    
    .item-sku {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .item-description {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .item-quantity {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    
    .item-kit-badge {
      display: inline-block;
      background: #dbeafe;
      color: #1d4ed8;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .complete-banner {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #22c55e;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      animation: slideUp 0.3s ease;
    }
    
    .complete-banner.show {
      display: block;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .reset-btn {
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Verificador de Envios</h1>
    <div class="account-badge" id="accountBadge">Sin conexion</div>
  </div>
  
  <div class="container">
    <div class="scan-section">
      <div class="scan-input-group">
        <input type="text" id="shipmentInput" class="scan-input" placeholder="Numero de envio..." inputmode="numeric" autocomplete="off">
        <button id="searchBtn" class="scan-btn">Buscar</button>
      </div>
      
      <button id="cameraBtn" class="camera-btn">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
        Escanear con camara
      </button>
      
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <div class="camera-overlay"></div>
        <button class="close-camera" id="closeCamera">✕</button>
      </div>
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    
    <div class="items-section hidden" id="itemsSection">
      <div class="items-header">
        <h2>Productos a verificar</h2>
        <span class="items-count" id="itemsCount">0/0</span>
      </div>
      <div id="itemsList"></div>
    </div>
    
    <button class="reset-btn hidden" id="resetBtn">Nuevo envio</button>
  </div>
  
  <div class="complete-banner" id="completeBanner">
    ✓ Envio verificado correctamente
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    const API_URL = window.location.origin;
    
    let currentItems = [];
    let checkedItems = new Set();
    let codeReader = null;
    let isScanning = false;
    
    const shipmentInput = document.getElementById('shipmentInput');
    const searchBtn = document.getElementById('searchBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const cameraContainer = document.getElementById('cameraContainer');
    const closeCamera = document.getElementById('closeCamera');
    const video = document.getElementById('video');
    const statusMessage = document.getElementById('statusMessage');
    const itemsSection = document.getElementById('itemsSection');
    const itemsList = document.getElementById('itemsList');
    const itemsCount = document.getElementById('itemsCount');
    const completeBanner = document.getElementById('completeBanner');
    const resetBtn = document.getElementById('resetBtn');
    const accountBadge = document.getElementById('accountBadge');
    
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message show ' + type;
    }
    
    function hideStatus() {
      statusMessage.className = 'status-message';
    }
    
    function updateItemsCount() {
      const total = currentItems.length;
      const checked = checkedItems.size;
      itemsCount.textContent = checked + '/' + total;
      
      if (checked === total && total > 0) {
        completeBanner.classList.add('show');
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100, 50, 200]);
        }
      } else {
        completeBanner.classList.remove('show');
      }
    }
    
    function renderItems() {
      itemsList.innerHTML = '';
      
      currentItems.forEach(function(item, index) {
        const isChecked = checkedItems.has(index);
        const card = document.createElement('div');
        card.className = 'item-card' + (isChecked ? ' checked' : '');
        
        card.innerHTML = 
          '<input type="checkbox" class="item-checkbox" ' + (isChecked ? 'checked' : '') + ' data-index="' + index + '">' +
          '<div class="item-info">' +
            '<div class="item-sku">' + item.sku + (item.isKit ? '<span class="item-kit-badge">KIT</span>' : '') + '</div>' +
            '<div class="item-description">' + item.description + '</div>' +
            '<div class="item-quantity">Cantidad: ' + item.quantity + '</div>' +
          '</div>';
        
        const checkbox = card.querySelector('.item-checkbox');
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            checkedItems.add(index);
            card.classList.add('checked');
          } else {
            checkedItems.delete(index);
            card.classList.remove('checked');
          }
          updateItemsCount();
        });
        
        card.addEventListener('click', function(e) {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });
        
        itemsList.appendChild(card);
      });
      
      updateItemsCount();
    }
    
    async function searchShipment(shipmentId) {
      if (!shipmentId || shipmentId.trim() === '') {
        showStatus('Ingresa un numero de envio', 'error');
        return;
      }
      
      showStatus('Buscando envio...', 'loading');
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const response = await fetch(API_URL + '/api/shipment/' + shipmentId.trim());
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error al buscar envio');
        }
        
        currentItems = data.items;
        checkedItems.clear();
        
        accountBadge.textContent = data.account;
        hideStatus();
        itemsSection.classList.remove('hidden');
        resetBtn.classList.remove('hidden');
        renderItems();
        
        stopCamera();
        
      } catch (error) {
        showStatus(error.message, 'error');
        itemsSection.classList.add('hidden');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Buscar';
      }
    }
    
    function startCamera() {
      if (!codeReader) {
        codeReader = new ZXing.BrowserBarcodeReader();
      }
      
      cameraContainer.classList.add('active');
      isScanning = true;
      
      codeReader.decodeFromVideoDevice(null, 'video', function(result, error) {
        if (result && isScanning) {
          isScanning = false;
          shipmentInput.value = result.getText();
          stopCamera();
          searchShipment(result.getText());
        }
      }).catch(function(err) {
        showStatus('No se pudo acceder a la camara', 'error');
        stopCamera();
      });
    }
    
    function stopCamera() {
      isScanning = false;
      cameraContainer.classList.remove('active');
      if (codeReader) {
        codeReader.reset();
      }
    }
    
    function reset() {
      currentItems = [];
      checkedItems.clear();
      shipmentInput.value = '';
      itemsSection.classList.add('hidden');
      resetBtn.classList.add('hidden');
      completeBanner.classList.remove('show');
      hideStatus();
      accountBadge.textContent = 'Sin conexion';
      shipmentInput.focus();
    }
    
    searchBtn.addEventListener('click', function() {
      searchShipment(shipmentInput.value);
    });
    
    shipmentInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchShipment(shipmentInput.value);
      }
    });
    
    cameraBtn.addEventListener('click', startCamera);
    closeCamera.addEventListener('click', stopCamera);
    resetBtn.addEventListener('click', reset);
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function() {});
    }
  </script>
</body>
</html>
